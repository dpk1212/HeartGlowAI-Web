<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HeartGlowAI</title>
  <meta name="description" content="AI-powered heartfelt message generator for all your relationships. Create authentic messages for loved ones.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff6b9d 0%, #64d2ff 100%);
      --bg-dark: #050A14;
      --card-bg: #101426;
      --text-primary: #FFFFFF;
      --text-secondary: #B7BAC1;
      --accent-pink: #ff6b9d;
      --accent-blue: #64d2ff;
      --accent-purple: #9460fb;
      --border-color: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(255, 255, 255, 0.05);
      --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --box-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      overscroll-behavior: none;
    }
    
    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 480px;
      margin: 0 auto;
      position: relative;
    }
    
    .screen {
      display: none;
      flex-direction: column;
      height: 100%;
      padding: 20px;
      opacity: 0;
      transform: scale(0.98) translateY(10px);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .screen.active {
      display: flex;
      opacity: 1;
      transform: scale(1) translateY(0);
      pointer-events: all;
    }
    
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      padding-top: 20px;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
    }
    
    .logo-heart {
      width: 36px;
      height: 36px;
      margin-right: 10px;
      background: var(--primary-gradient);
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
      animation: glow 4s ease-in-out infinite alternate;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 700;
    }
    
    /* Welcome Screen */
    .welcome-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
      background-color: var(--bg-dark);
      position: relative;
      overflow: hidden;
    }
    
    .welcome-content {
      max-width: 600px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
      animation: fadeIn 1s ease-out;
      position: relative;
      z-index: 1;
    }
    
    .welcome-heart {
      width: 180px;
      height: 180px;
      margin-bottom: 60px;
      position: relative;
      animation: float 6s ease-in-out infinite;
    }
    
    .welcome-heart svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 0 10px rgba(255, 107, 157, 0.5)) 
              drop-shadow(0 0 20px rgba(100, 210, 255, 0.3));
    }
    
    .welcome-heart path {
      stroke: url(#heartGradient);
      stroke-width: 2.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 1500;
      stroke-dashoffset: 1500;
      animation: drawHeart 2s ease-out forwards;
    }
    
    .welcome-title {
      font-size: 42px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 24px;
      line-height: 1.2;
    }
    
    .welcome-subtitle {
      font-size: 18px;
      color: var(--text-secondary);
      margin-bottom: 48px;
      line-height: 1.5;
    }
    
    #login-register-btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 100px;
      cursor: pointer;
      width: 100%;
      max-width: 300px;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth);
    }
    
    #login-register-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }
    
    #login-register-btn:active {
      transform: scale(0.98);
    }
    
    /* Animated background for welcome screen */
    .welcome-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 20%, rgba(255, 107, 157, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(100, 210, 255, 0.05) 0%, transparent 50%);
      animation: gradientMove 20s ease-in-out infinite alternate;
      z-index: 0;
    }
    
    @keyframes drawHeart {
      to {
        stroke-dashoffset: 0;
      }
    }
    
    /* Auth Screen */
    .auth-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      align-items: center;
      justify-content: center;
    }
    
    .auth-logo {
      width: 60px;
      height: 60px;
      margin-bottom: 40px;
      background: var(--primary-gradient);
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
    }
    
    .auth-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 40px;
    }
    
    .auth-form {
      width: 100%;
      max-width: 320px;
    }
    
    .input-label {
      display: block;
      font-size: 15px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .input-field, select, textarea {
      width: 100%;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      color: white;
      margin-bottom: 20px;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
      backdrop-filter: blur(8px);
    }
    
    .input-field::placeholder, select option, textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .input-field:focus, select:focus, textarea:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(100, 210, 255, 0.2);
      outline: none;
      animation: focusPulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    
    .auth-links {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 320px;
      margin-top: 16px;
    }
    
    .auth-link {
      color: var(--accent-blue);
      text-decoration: none;
      font-size: 14px;
    }
    
    /* Home Screen */
    .home-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .home-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.2;
    }
    
    .home-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
    }
    
    .home-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      gap: 12px;
    }
    
    .section-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      color: var(--text-primary);
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .section-title:after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-color);
      margin-left: 15px;
    }
    
    .settings-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      border-radius: 12px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background-color var(--transition-fast);
      flex: 1;
    }
    
    .settings-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .settings-icon {
      margin-right: 8px;
      font-size: 16px;
    }
    
    .new-conversation-btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 18px 16px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 30px;
      text-align: center;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth), filter var(--transition-smooth);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .new-conversation-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      filter: brightness(1.05);
    }
    
    .new-conversation-btn:active {
      transform: translateY(1px) scale(0.98);
    }
    
    .new-conversation-icon {
      margin-right: 10px;
      font-size: 20px;
    }
    
    .templates-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .templates-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 480px) {
      .templates-grid {
        grid-template-columns: 1fr;
      }
      
      .template-card {
        padding: 20px 16px;
      }
    }
    
    .templates-section {
      margin-top: 10px;
    }
    
    .template-card {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 24px 20px;
      text-align: center;
      cursor: pointer;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth), background-color var(--transition-smooth);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .template-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: var(--box-shadow-hover);
      background-color: rgba(255, 255, 255, 0.03);
    }
    
    .template-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 14px;
      font-size: 24px;
      background: linear-gradient(135deg, rgba(255, 107, 157, 0.1) 0%, rgba(100, 210, 255, 0.1) 100%);
    }
    
    .template-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .template-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    .template-category {
      margin-top: 36px;
      margin-bottom: 16px;
    }
    
    .category-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }
    
    .category-title::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 14px;
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
      margin-right: 10px;
      border-radius: 2px;
    }
    
    .template-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, 
        rgba(255, 107, 157, 0.1) 0%, 
        rgba(100, 210, 255, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .template-card:hover::before {
      opacity: 1;
    }
    
    .template-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 12px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform var(--transition-fast);
    }
    
    .template-icon.apology {
      background-color: #4A5AEF;
    }
    
    .template-icon.romantic {
      background-color: #FF4B91;
    }
    
    .template-icon.tough {
      background-color: #FF5C5C;
    }
    
    .template-icon.checkin {
      background-color: #9747FF;
    }
    
    .template-name {
      font-size: 15px;
      font-weight: 500;
    }
    
    .template-card:hover .template-icon {
      transform: scale(1.1);
    }
    
    /* Message Generator Screen */
    .generator-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .back-button {
      display: flex;
      align-items: center;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 16px;
      cursor: pointer;
      padding: 0;
      margin-bottom: 20px;
    }
    
    .back-icon {
      margin-right: 8px;
    }
    
    .scenario-textarea {
      width: 100%;
      min-height: 120px;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      color: white;
      margin-bottom: 20px;
      resize: none;
    }
    
    .relationship-select {
      width: 100%;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      color: white;
      margin-bottom: 20px;
      appearance: none;
    }
    
    .result-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-top: 20px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s ease, transform 0.4s ease;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .result-card[style*="display: block"] {
      opacity: 1;
      transform: translateY(0);
    }
    
    .message-text {
      font-size: 18px;
      line-height: 1.7;
      margin-bottom: 24px;
      white-space: pre-wrap;
      color: var(--text-primary);
      padding: 5px;
      border-left: 3px solid var(--accent-pink);
      background-color: rgba(255, 255, 255, 0.03);
      padding-left: 15px;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      width: 100%;
    }
    
    .copy-button, .tweak-button {
      all: unset; /* Reset all styles first */
      background: var(--primary-gradient);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      width: 100%;
      height: 44px;
      position: relative;
      overflow: hidden;
    }
    
    .copy-button:hover, .tweak-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }
    
    .copy-button:active, .tweak-button:active {
      transform: scale(0.95) translateY(1px);
      transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .copy-button::after, .tweak-button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    .copy-button:active::after, .tweak-button:active::after {
      animation: ripple 0.5s ease-out;
    }
    
    .feedback-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      display: none;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height var(--transition-smooth), opacity var(--transition-smooth);
    }
    
    .feedback-section[style*="display: block"] {
      max-height: 500px;
      opacity: 1;
    }
    
    .feedback-input {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text-primary);
      margin: 10px 0;
      font-family: inherit;
      resize: vertical;
    }
    
    .feedback-section label {
      display: block;
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .feedback-section .tweak-button {
      width: 100%;
      margin-top: 10px;
    }
    
    .insights-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }
    
    .insights-title {
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .insights-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .insight-item {
      font-size: 0.9em;
      color: var(--text-secondary);
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }
    
    .insight-item:before {
      content: "•";
      position: absolute;
      left: 0;
      color: var(--primary-color);
    }
    
    .loading-spinner {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 40px auto;
      position: relative;
      min-height: 180px;
      text-align: center;
      width: 100%;
    }
    
    .loading-context {
      color: var(--text-primary);
      margin-top: 24px;
      font-size: 16px;
      max-width: 80%;
      text-align: center;
      animation: fadeIn 0.5s ease forwards;
      font-weight: 500;
    }
    
    .loading-highlight {
      color: var(--accent-pink);
      font-weight: 600;
    }
    
    .heart-spinner {
      width: 60px;
      height: 60px;
      position: relative;
      animation: heartBeat 1.2s ease-in-out infinite;
    }
    
    .heart-spinner::before,
    .heart-spinner::after {
      content: "";
      position: absolute;
      top: 0;
      width: 30px;
      height: 50px;
      border-radius: 50px 50px 0 0;
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
    }
    
    .heart-spinner::before {
      left: 0;
      transform: rotate(-45deg);
      transform-origin: 100% 100%;
    }
    
    .heart-spinner::after {
      right: 0;
      transform: rotate(45deg);
      transform-origin: 0 100%;
    }
    
    @keyframes heartBeat {
      0% {
        transform: scale(0.8);
        opacity: 0.7;
      }
      25% {
        transform: scale(1.1);
        opacity: 1;
      }
      50% {
        transform: scale(0.9);
        opacity: 0.9;
      }
      100% {
        transform: scale(0.8);
        opacity: 0.7;
      }
    }
    
    .spinner-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(
        circle,
        rgba(255, 107, 157, 0.3) 0%,
        rgba(100, 210, 255, 0) 70%
      );
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0.5;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 0.2;
      }
      100% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0.5;
      }
    }
    
    /* Message Generation Form */
    .form-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      transform: translateY(20px);
      opacity: 0;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    label {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    select, textarea {
      background-color: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text-primary);
      padding: 12px;
      font-size: 16px;
      font-family: inherit;
    }
    
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    #circumstances {
      min-height: 80px;
    }

    .slider-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--primary-gradient);
      outline: none;
      transition: background var(--transition-fast);
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      border: none;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      color: var(--text-secondary);
      font-size: 12px;
      padding: 0 2px;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(100, 210, 255, 0.4);
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(255, 107, 157, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(100, 210, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, var(--bg-dark) 0%, var(--bg-dark) 100%);
      z-index: -1;
      animation: gradientMove 20s ease-in-out infinite alternate;
    }

    @keyframes gradientMove {
      0% {
        background-position: 0% 0%;
      }
      100% {
        background-position: 100% 100%;
      }
    }

    /* Floating animation for the welcome hero */
    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-20px);
      }
    }

    /* Glowing effect for the logo */
    @keyframes glow {
      0% {
        filter: drop-shadow(0 0 2px rgba(255, 107, 157, 0.5));
      }
      100% {
        filter: drop-shadow(0 0 10px rgba(100, 210, 255, 0.5));
      }
    }

    /* Generator screen animations */
    @keyframes slideUp {
      0% {
        transform: translateY(50px);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Input field focus animation */
    @keyframes focusPulse {
      0% {
        box-shadow: 0 0 0 2px rgba(100, 210, 255, 0.2);
      }
      50% {
        box-shadow: 0 0 0 4px rgba(100, 210, 255, 0.1);
      }
      100% {
        box-shadow: 0 0 0 2px rgba(100, 210, 255, 0.2);
      }
    }

    /* Enhanced loading animation */
    .loading-spinner::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60px;
      height: 60px;
      margin: -30px 0 0 -30px;
      border-radius: 50%;
      background: var(--primary-gradient);
      opacity: 0.1;
      animation: pulseLoader 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }

    @keyframes pulseLoader {
      0% {
        transform: scale(0.8);
        opacity: 0.1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.2;
      }
      100% {
        transform: scale(0.8);
        opacity: 0.1;
      }
    }

    /* Result card appearance animation */
    .result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg,
        rgba(255, 107, 157, 0.05) 0%,
        rgba(100, 210, 255, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .result-card[style*="display: block"]::before {
      opacity: 1;
    }

    /* Button press effect enhancement */
    .btn:active, .copy-button:active, .tweak-button:active {
      transform: scale(0.95) translateY(1px);
      transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Add Google Sign In button styles */
    .google-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      color: #333;
      border: none;
      border-radius: 100px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin: 20px 0;
      width: 100%;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .google-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }
    
    .google-btn img {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }

    .auth-divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 20px 0;
      color: var(--text-secondary);
    }

    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--border-color);
    }

    .auth-divider span {
      padding: 0 10px;
      font-size: 14px;
    }

    /* Add the neon heart animation styles */
    @keyframes neonPulse {
      0% {
        filter: drop-shadow(0 0 2px rgba(255, 59, 139, 0.8)) 
                drop-shadow(0 0 4px rgba(140, 70, 255, 0.8))
                drop-shadow(0 0 6px rgba(59, 138, 255, 0.8));
      }
      50% {
        filter: drop-shadow(0 0 4px rgba(255, 59, 139, 0.9))
                drop-shadow(0 0 8px rgba(140, 70, 255, 0.9))
                drop-shadow(0 0 12px rgba(59, 138, 255, 0.9));
      }
      100% {
        filter: drop-shadow(0 0 2px rgba(255, 59, 139, 0.8))
                drop-shadow(0 0 4px rgba(140, 70, 255, 0.8))
                drop-shadow(0 0 6px rgba(59, 138, 255, 0.8));
      }
    }

    .neon-heart {
      width: 280px;
      height: 280px;
      margin-bottom: 40px;
      animation: float 6s ease-in-out infinite;
      position: relative;
    }

    .neon-heart svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 0 4px rgba(255, 59, 139, 0.8))
              drop-shadow(0 0 8px rgba(140, 70, 255, 0.8))
              drop-shadow(0 0 12px rgba(59, 138, 255, 0.8));
      animation: neonPulse 2s ease-in-out infinite;
    }

    .neon-heart path {
      stroke-dasharray: 1500;
      stroke-dashoffset: 1500;
      animation: drawHeart 3s ease-out forwards;
    }

    @keyframes drawHeart {
      to {
        stroke-dashoffset: 0;
      }
    }

    /* Feedback Modal Styles */
    .feedback-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 999;
      display: none;
    }

    .feedback-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 92%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      display: none;
    }

    .feedback-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      text-align: center;
    }

    .feedback-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      text-align: center;
    }

    .feedback-section {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .feedback-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .feedback-section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .feedback-input {
      width: 100%;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      color: var(--text-primary);
      margin-bottom: 16px;
      font-size: 14px;
    }

    .feedback-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .star-rating {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-start;
      margin-bottom: 16px;
    }

    .star-rating input {
      display: none;
    }

    .star-rating label {
      font-size: 24px;
      color: var(--text-secondary);
      margin-right: 8px;
      cursor: pointer;
    }

    .star-rating label:hover,
    .star-rating label:hover ~ label,
    .star-rating input:checked ~ label {
      color: var(--accent-pink);
    }

    .checkbox-group {
      margin: 16px 0;
    }

    .checkbox-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .checkbox-options label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
      cursor: pointer;
    }

    .nps-scale {
      margin: 16px 0;
    }

    .nps-slider {
      width: 100%;
      margin: 8px 0;
    }

    .nps-labels {
      display: flex;
      justify-content: space-between;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .feedback-button-container {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .feedback-submit {
      flex: 1;
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--transition-smooth);
    }

    .feedback-cancel {
      flex: 1;
      background-color: var(--input-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--transition-smooth);
    }

    .feedback-button {
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth), background-color var(--transition-smooth);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      font-size: 15px;
    }

    .feedback-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .feedback-icon {
      margin-right: 8px;
      font-size: 16px;
    }

    /* Template Card Additional Styles */
    .template-icon.gratitude {
      background-color: #FFB156;
    }

    .template-icon.celebration {
      background-color: #FF56B1;
    }

    .template-icon.encouragement {
      background-color: #56B4FF;
    }

    .template-icon.sympathy {
      background-color: #A256FF;
    }

    /* Improve the primary button */
    .primary-button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      margin-bottom: 10px;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                  box-shadow 0.3s ease,
                  filter 0.3s ease;
      position: relative;
      overflow: hidden;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .primary-button:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      filter: brightness(1.05);
    }
    
    .primary-button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .button-content {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      position: relative;
      z-index: 1;
    }
    
    .button-icon {
      margin-left: 10px;
      font-size: 20px;
    }
    
    /* Button click animation */
    .primary-button::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 10%, transparent 70%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform 0.5s, opacity 0.8s;
    }
    
    .primary-button:active::after {
      transform: scale(0, 0);
      opacity: 0.3;
      transition: 0s;
    }
    
    /* Make insights more prominent */
    .insights-section {
      margin-top: 24px;
      padding: 20px;
      border-radius: 12px;
      background: linear-gradient(135deg, 
        rgba(255, 107, 157, 0.07) 0%, 
        rgba(100, 210, 255, 0.07) 100%);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .insights-title {
      font-size: 16px;
      color: var(--text-primary);
      margin-bottom: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
    }
    
    .insights-title::before {
      content: '💡';
      margin-right: 10px;
      font-size: 18px;
    }
    
    .insight-item {
      font-size: 15px;
      color: var(--text-primary);
      margin-bottom: 12px;
      padding-left: 24px;
      position: relative;
      line-height: 1.5;
    }
    
    .insight-item:before {
      content: "✓";
      position: absolute;
      left: 0;
      color: var(--accent-blue);
      font-weight: bold;
    }

    .generating {
      position: relative;
      overflow: hidden;
      pointer-events: none;
    }
    
    .generate-animation {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      z-index: 0;
      animation: shimmer 1.5s linear infinite;
    }
    
    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    /* Full-screen loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(5, 10, 20, 0.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
      max-width: 400px;
      width: 100%;
    }
    
    .loading-context {
      color: var(--text-primary);
      margin-top: 30px;
      font-size: 18px;
      line-height: 1.5;
      text-align: center;
      animation: fadeIn 0.5s ease forwards;
      font-weight: 500;
    }
    
    .loading-highlight {
      color: var(--accent-pink);
      font-weight: 700;
    }
    
    /* Professional heart animation */
    .heart-animation {
      position: relative;
      width: 100px;
      height: 100px;
    }
    
    .heart-shape {
      position: absolute;
      width: 100%;
      height: 100%;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 87.5C47.8333 87.5 45.6667 86.6667 43.5 85C23.1667 69.1667 10 53.75 10 35.8333C10 22.5 20 12.5 33.3333 12.5C40.8333 12.5 47.5 16.25 50 21.6667C52.5 16.25 59.1667 12.5 66.6667 12.5C80 12.5 90 22.5 90 35.8333C90 53.75 76.8333 69.1667 56.5 85C54.3333 86.6667 52.1667 87.5 50 87.5Z' fill='url(%23heartGradient)'/%3E%3Cdefs%3E%3ClinearGradient id='heartGradient' x1='10' y1='12.5' x2='90' y2='87.5' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23ff6b9d'/%3E%3Cstop offset='1' stop-color='%2364d2ff'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E") center/contain no-repeat;
      transform-origin: center;
      opacity: 0.9;
      animation: heartPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes heartPulse {
      0% { transform: scale(0.95); opacity: 0.7; }
      50% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(0.95); opacity: 0.7; }
    }
    
    .heart-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120%;
      height: 120%;
      background: radial-gradient(
        circle,
        rgba(255, 107, 157, 0.3) 0%,
        rgba(100, 210, 255, 0.1) 50%,
        rgba(0, 0, 0, 0) 70%
      );
      border-radius: 50%;
      animation: glowPulse 2s ease-in-out infinite;
    }
    
    .heart-particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
      opacity: 0;
      animation: particleRise 3s ease-out infinite;
    }
    
    .particle:nth-child(1) {
      left: 30%;
      top: 60%;
      animation-delay: 0.2s;
    }
    
    .particle:nth-child(2) {
      left: 45%;
      top: 70%;
      animation-delay: 0.5s;
    }
    
    .particle:nth-child(3) {
      left: 60%;
      top: 60%;
      animation-delay: 0.8s;
    }
    
    .particle:nth-child(4) {
      left: 70%;
      top: 50%;
      animation-delay: 1.1s;
    }
    
    .particle:nth-child(5) {
      left: 35%;
      top: 50%;
      animation-delay: 1.4s;
    }
    
    @keyframes particleRise {
      0% { transform: translateY(0) scale(1); opacity: 0; }
      20% { opacity: 0.8; }
      100% { transform: translateY(-60px) scale(0); opacity: 0; }
    }
    
    @keyframes glowPulse {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.3; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.5; }
      100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.3; }
    }

    /* Results Popup */
    .results-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(5, 10, 20, 0.95);
      backdrop-filter: blur(12px);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease, visibility 0.4s ease;
      padding: 24px;
    }
    
    .results-overlay.active {
      opacity: 1;
      visibility: visible;
      display: flex;
    }
    
    .results-container {
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.05) 0%,
        rgba(255, 255, 255, 0.02) 100%
      );
      border-radius: 24px;
      padding: 0;
      width: 100%;
      max-width: 800px;
      height: 90vh;
      max-height: 800px;
      position: relative;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      overflow: hidden;
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 32px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.02);
    }
    
    .results-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
    }
    
    .results-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 28px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
    }
    
    .results-close:hover {
      color: var(--text-primary);
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.1);
    }
    
    .results-body {
      padding: 32px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .message-container {
      position: relative;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .message-text {
      font-size: 18px;
      line-height: 1.7;
      margin: 0;
      white-space: pre-wrap;
      color: var(--text-primary);
      position: relative;
      font-weight: 400;
    }
    
    .results-actions {
      display: flex;
      gap: 16px;
      margin: 0;
    }
    
    .copy-button, .tweak-button {
      flex: 1;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      gap: 8px;
    }
    
    .copy-button:hover, .tweak-button:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 10px 20px -10px rgba(0, 0, 0, 0.3);
    }
    
    .action-icon {
      font-size: 20px;
    }
    
    .copy-button .action-icon {
      color: var(--accent-blue);
    }
    
    .tweak-button .action-icon {
      color: var(--accent-pink);
    }
    
    .insights-container {
      background: linear-gradient(
        135deg,
        rgba(255, 107, 157, 0.05) 0%,
        rgba(100, 210, 255, 0.05) 100%
      );
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .insights-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      color: var(--text-primary);
      gap: 12px;
    }
    
    .insights-title::before {
      content: '💡';
      font-size: 24px;
    }
    
    .insights-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .insight-item {
      position: relative;
      padding-left: 32px;
      color: var(--text-primary);
      font-size: 16px;
      line-height: 1.6;
    }
    
    .insight-item::before {
      content: "✓";
      position: absolute;
      left: 0;
      top: 2px;
      color: var(--accent-blue);
      font-weight: bold;
      font-size: 18px;
    }
    
    .feedback-form {
      margin-top: 0;
      padding: 24px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: none;
    }
    
    .feedback-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      color: var(--text-primary);
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      min-height: 120px;
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }
    
    .feedback-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(100, 210, 255, 0.1);
    }
    
    .submit-feedback-btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease;
    }
    
    .submit-feedback-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -10px rgba(0, 0, 0, 0.3);
    }
    
    @keyframes slideUp {
      0% {
        transform: translateY(40px);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .results-container {
        height: 100vh;
        max-height: none;
        border-radius: 0;
      }
      
      .results-header {
        padding: 20px;
      }
      
      .results-body {
        padding: 20px;
      }
      
      .results-title {
        font-size: 20px;
      }
      
      .message-text {
        font-size: 16px;
      }
      
      .copy-button, .tweak-button {
        padding: 14px;
        font-size: 15px;
      }
    }

    .feedback-form {
      margin: 20px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }

    .feedback-input {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-size: 14px;
      margin-bottom: 12px;
      resize: vertical;
    }

    .feedback-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(255, 107, 157, 0.2);
    }

    .submit-feedback-button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: var(--primary-gradient);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .submit-feedback-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
    }

    .message-insights {
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Welcome Screen -->
    <div id="welcome-screen" class="screen active">
      <div class="welcome-container">
        <div class="welcome-content">
          <div class="welcome-heart">
            <svg viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:var(--accent-pink)"/>
                  <stop offset="100%" style="stop-color:var(--accent-blue)"/>
                </linearGradient>
              </defs>
              <path d="M256 412.8L219.2 379.2C128 298.7 68.3 245.3 68.3 177.9C68.3 123.2 111.5 80 166.2 80C195.8 80 224.1 93.1 256 118.4C287.9 93.1 316.2 80 345.8 80C400.5 80 443.7 123.2 443.7 177.9C443.7 245.3 384 298.7 292.8 379.2L256 412.8Z"/>
            </svg>
          </div>
          <h1 class="welcome-title">Say what you feel, the way they'll hear it.</h1>
          <p class="welcome-subtitle">AI-powered heartfelt message generator for all your relationships</p>
          <button id="login-register-btn">Log in or Register</button>
        </div>
      </div>
    </div>
    
    <!-- Auth Screen -->
    <div id="auth-screen" class="screen">
      <div class="auth-container">
        <div class="auth-logo"></div>
        <h1 class="auth-title">Log in or sign up</h1>
        
        <!-- Add Google Sign In button -->
        <button id="google-sign-in" class="google-btn">
          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMTcuNiA5LjJsLS4xLTEuOEg5djMuNGg0LjhDMTMuNiAxMiAxMyAxMyAxMiAxMy42djIuMmgzYTguOCA4LjggMCAwIDAgMi42LTYuNnoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjxwYXRoIGQ9Ik05IDE4YzIuNCAwIDQuNS0uOCA2LTIuMmwtMy0yLjJhNS40IDUuNCAwIDAgMS04LTIuOUgxVjEzYTkgOSAwIDAgMCA4IDV6IiBmaWxsPSIjMzRBODUzIiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNNCAxMC43YTUuNCA1LjQgMCAwIDEgMC0zLjRWNUgxYTkgOSAwIDAgMCAwIDhsMy0yLjN6IiBmaWxsPSIjRkJCQzA1IiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNOSAzLjZjMS4zIDAgMi41LjQgMy40IDEuM0wxNSAyLjNBOSA5IDAgMCAwIDEgNWwzIDIuNGE1LjQgNS40IDAgMCAxIDUtMy43eiIgZmlsbD0iI0VBNDMzNSIgZmlsbC1ydWxlPSJub256ZXJvIi8+PHBhdGggZD0iTTAgMGgxOHYxOEgweiIvPjwvZz48L3N2Zz4=" alt="Google logo">
          Continue with Google
        </button>
        
        <div class="auth-divider">
          <span>or continue with email</span>
        </div>
        
        <form id="auth-form" class="auth-form">
          <label class="input-label" for="email">Email</label>
          <input type="email" id="email" class="input-field" placeholder="Enter your email">
          
          <label class="input-label" for="password">Password</label>
          <input type="password" id="password" class="input-field" placeholder="Enter your password">
          
          <button type="submit" id="auth-submit-btn" class="btn">Continue</button>
        </form>
        <div class="auth-links">
          <span id="auth-toggle-text">Don't have an account?</span>
          <a href="#" id="auth-toggle-link" class="auth-link">Sign up</a>
        </div>
        <div class="auth-links">
          <a href="#" id="forgot-password-link" class="auth-link">Forgot password?</a>
        </div>
      </div>
    </div>
    
    <!-- Home Screen -->
    <div id="home-screen" class="screen">
      <div class="header">
        <div class="logo-container">
          <div class="logo-heart"></div>
          <span class="logo-text">HeartGlowAI</span>
        </div>
      </div>
      
      <div class="home-header">
        <h1 class="home-title">Start a meaningful conversation</h1>
        <p class="home-subtitle">Choose a template or start fresh — we'll guide you.</p>
      </div>
      
      <div class="home-actions">
        <button id="history-btn" class="settings-btn">
          <span class="settings-icon">📋</span> History
        </button>
        
        <button id="logout-btn" class="settings-btn">
          <span class="settings-icon">👤</span> Logout
        </button>
      </div>
      
      <button id="new-conversation-btn" class="new-conversation-btn">
        <span class="new-conversation-icon">💬</span> Start a New Conversation
      </button>
      
      <!-- Templates Section -->
      <div id="templates-section" class="templates-section">
        <h2 class="section-title">Message Templates</h2>
        
        <!-- Everyday Check-ins Category -->
        <div class="template-category">
          <h3 class="category-title">Everyday Check-Ins</h3>
          <div class="templates-grid">
            <div class="template-card" data-template="checkin">
              <div class="template-icon">👋</div>
              <div class="template-name">Check-In</div>
              <div class="template-description">Reconnect with someone you haven't spoken to in a while</div>
            </div>
            <div class="template-card" data-template="encouragement">
              <div class="template-icon">⭐</div>
              <div class="template-name">Encouragement</div>
              <div class="template-description">Offer support during a challenging time</div>
            </div>
          </div>
        </div>
        
        <!-- Repair & Reconnect Category -->
        <div class="template-category">
          <h3 class="category-title">Repair & Reconnect</h3>
          <div class="templates-grid">
            <div class="template-card" data-template="apology">
              <div class="template-icon">✉️</div>
              <div class="template-name">Apology</div>
              <div class="template-description">Make amends with empathy and sincerity</div>
            </div>
            <div class="template-card" data-template="tough">
              <div class="template-icon">💬</div>
              <div class="template-name">Tough Talk</div>
              <div class="template-description">Navigate a difficult conversation with respect</div>
            </div>
          </div>
        </div>
        
        <!-- Celebrate & Appreciate Category -->
        <div class="template-category">
          <h3 class="category-title">Celebrate & Appreciate</h3>
          <div class="templates-grid">
            <div class="template-card" data-template="romantic">
              <div class="template-icon">❤️</div>
              <div class="template-name">Romantic</div>
              <div class="template-description">Express your love and affection</div>
            </div>
            <div class="template-card" data-template="gratitude">
              <div class="template-icon">🙏</div>
              <div class="template-name">Gratitude</div>
              <div class="template-description">Show appreciation for their support</div>
            </div>
            <div class="template-card" data-template="celebration">
              <div class="template-icon">🎉</div>
              <div class="template-name">Celebration</div>
              <div class="template-description">Congratulate someone on their achievement</div>
            </div>
            <div class="template-card" data-template="sympathy">
              <div class="template-icon">💐</div>
              <div class="template-name">Sympathy</div>
              <div class="template-description">Offer comfort during a difficult time</div>
            </div>
          </div>
        </div>
        
        <button id="feedbackButton" class="feedback-button">
          <span class="feedback-icon">⭐</span> Submit Feedback
        </button>
      </div>
    </div>
    
    <!-- Message Generator Screen -->
    <div id="generator-screen" class="screen">
      <button id="back-to-home-btn" class="back-button">
        <span class="back-icon">←</span> Back
      </button>
      
      <div class="generator-container">
        <div class="form-container">
          <div class="input-group">
            <label for="scenario">What would you like to say?</label>
            <textarea id="scenario" placeholder="Example: I want to express my gratitude for their support during a difficult time"></textarea>
          </div>
          
          <div class="input-group">
            <label for="relationship">Relationship Type</label>
            <select id="relationship">
              <option value="Friend">Friend</option>
              <option value="Romantic Partner">Romantic Partner</option>
              <option value="Family Member">Family Member</option>
              <option value="Professional">Professional</option>
              <option value="Mentor">Mentor</option>
            </select>
          </div>
          
          <div class="input-group">
            <label for="tone">Message Tone</label>
            <select id="tone">
              <option value="casual">Casual</option>
              <option value="formal">Formal</option>
              <option value="humorous">Humorous</option>
              <option value="serious">Serious</option>
              <option value="poetic">Poetic</option>
              <option value="professional">Professional</option>
            </select>
          </div>
          
          <div class="input-group">
            <label for="intensity">Tone Intensity</label>
            <div class="slider-container">
              <input type="range" id="intensity" min="1" max="5" value="3" class="slider">
              <div class="slider-labels">
                <span>Subtle</span>
                <span>Balanced</span>
                <span>Strong</span>
              </div>
            </div>
          </div>
          
          <div class="input-group">
            <label for="duration">Relationship Duration</label>
            <select id="duration">
              <option value="unspecified">Not specified</option>
              <option value="new">New/Recent</option>
              <option value="few months">Few months</option>
              <option value="1-5 years">1-5 years</option>
              <option value="5+ years">5+ years</option>
              <option value="lifelong">Lifelong</option>
            </select>
          </div>
          
          <div class="input-group">
            <label for="circumstances">Special Circumstances (Optional)</label>
            <textarea id="circumstances" placeholder="Example: We recently had an argument, or They're going through a tough time"></textarea>
          </div>
          
          <button id="generateBtn" class="primary-button">
            <span class="button-content">
              Generate Message
              <span class="button-icon">✨</span>
            </span>
          </button>
        </div>
        
        <div id="result" class="result-card" style="display: none;">
          <div class="message-text" id="messageText"></div>
          <div class="button-group">
            <button class="copy-button" onclick="copyMessage()">Copy Message</button>
            <button class="tweak-button" onclick="showFeedback()">Tweak Message</button>
          </div>
          <div class="feedback-section" id="feedbackSection">
            <label for="feedback">How would you like to improve this message?</label>
            <textarea id="feedback" class="feedback-input" placeholder="Example: Make it more formal, add more emotion, be more specific about..."></textarea>
            <button class="tweak-button" onclick="tweakMessage()">Generate New Version</button>
          </div>
          <div class="insights-section">
            <div class="insights-title">Why this message works:</div>
            <ul class="insights-list" id="insightsList"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-container">
      <div class="heart-animation">
        <div class="heart-shape"></div>
        <div class="heart-glow"></div>
        <div class="heart-particles">
          <div class="particle"></div>
          <div class="particle"></div>
          <div class="particle"></div>
          <div class="particle"></div>
          <div class="particle"></div>
        </div>
      </div>
      <div id="loadingContext" class="loading-context">Creating your message...</div>
    </div>
  </div>
  
  <!-- Results popup overlay -->
  <div class="results-overlay" id="resultsOverlay">
    <div class="results-container">
      <div class="results-header">
        <h2>Your Message</h2>
        <button class="close-button" onclick="hideResults()">×</button>
      </div>
      
      <div class="message-content">
        <p id="messageText"></p>
      </div>

      <div class="action-buttons">
        <button onclick="copyMessage()" class="action-button">
          📋 Copy Message
        </button>
        <button onclick="showFeedback()" class="action-button">
          ✏️ Tweak Message
        </button>
      </div>

      <!-- Feedback form - Now above insights -->
      <div id="resultsFeedbackForm" class="feedback-form" style="display: none;">
        <textarea id="resultsFeedbackInput" 
                  placeholder="How can we improve this message? Your feedback helps us get better."
                  class="feedback-input"></textarea>
        <button onclick="tweakMessage()" class="submit-feedback-button">
          Submit Feedback
        </button>
      </div>

      <!-- Insights section -->
      <div class="message-insights">
        <h3>💡 Why this message works:</h3>
        <ul id="messageInsights" class="insights-list"></ul>
      </div>
    </div>
  </div>

  <script>
    // API Configuration
    const API_CONFIG = {
      BASE_URL: 'https://heartglowai.com',  // Update to use the main domain
      ENDPOINTS: {
        GENERATE: '/api/generate',
        FEEDBACK: '/api/feedback',
        HISTORY: '/api/history'
      }
    };

    // Global variables and functions
    let currentMessage = '';
    let currentUser = null;
    let welcomeScreen, authScreen, homeScreen, generatorScreen;
    let messageCount = 0;
    let hasSubmittedFeedback = false;

    // Helper function for API calls
    async function makeApiRequest(endpoint, data, options = {}) {
      const url = `${API_CONFIG.BASE_URL}${endpoint}`;
      console.log(`Making API request to: ${url}`);

      try {
        // Get auth token if user is logged in
        let headers = {
          'Content-Type': 'application/json'
        };

        if (currentUser) {
          const idToken = await currentUser.getIdToken();
          headers['Authorization'] = `Bearer ${idToken}`;
        }

        const response = await fetch(url, {
          method: options.method || 'POST',
          headers: headers,
          body: JSON.stringify(data),
          mode: 'cors'
        });

        console.log('Response status:', response.status);

        // Handle non-JSON responses
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Invalid response format from server');
        }

        const responseData = await response.json();
        console.log('Response data:', responseData);

        if (!response.ok) {
          const error = new Error(responseData.error || 'Request failed');
          error.status = response.status;
          throw error;
        }

        return responseData;
      } catch (error) {
        console.error('API request failed:', error);
        
        // Enhanced error handling
        if (error.message.includes('Failed to fetch')) {
          throw new Error('Unable to connect to the server. Please check your connection and try again.');
        } else if (error.status === 403) {
          throw new Error('Access denied. Please check your authentication.');
        } else if (error.status === 429) {
          throw new Error('Too many requests. Please try again in a moment.');
        } else {
          throw error;
        }
      }
    }

    // Screen transition function
    function showScreen(screen) {
      const screens = [welcomeScreen, authScreen, homeScreen, generatorScreen];
      screens.forEach(s => {
        if (s === screen) {
          s.style.display = 'flex';
          setTimeout(() => s.classList.add('active'), 50);
        } else {
          s.classList.remove('active');
          setTimeout(() => {
            if (!s.classList.contains('active')) {
              s.style.display = 'none';
            }
          }, 500);
        }
      });
    }

    // Initialize app function
    function initializeApp() {
      // Initialize screen elements
      welcomeScreen = document.getElementById('welcome-screen');
      authScreen = document.getElementById('auth-screen');
      homeScreen = document.getElementById('home-screen');
      generatorScreen = document.getElementById('generator-screen');

      // Add favicon
      const favicon = document.createElement('link');
      favicon.rel = 'icon';
      favicon.type = 'image/svg+xml';
      favicon.href = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z' fill='%23ff6b9d'/%3E%3C/svg%3E";
      document.head.appendChild(favicon);

      // Show welcome screen by default
      showScreen(welcomeScreen);
    }

    // Save message to history function
    async function saveMessage(scenario, relationship, message) {
      // Skip if user is not authenticated
      if (!currentUser) {
        console.log('Message not saved to history - user not authenticated');
        return;
      }

      try {
        const requestData = {
          scenario,
          relationshipType: relationship,
          message,
          userId: currentUser.uid,
          timestamp: new Date().toISOString()
        };

        // Try to save to history, but don't block on failure
        await Promise.race([
          makeApiRequest(API_CONFIG.ENDPOINTS.HISTORY, requestData),
          new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Save timeout')), 5000)
          )
        ]);
        
        console.log('Message saved to history successfully');
      } catch (error) {
        // Log error but don't surface to user since this is a background operation
        console.log('Note: Message history not saved -', error.message);
      }
    }

    // Global functions for feedback and copy functionality
    window.showFeedback = function() {
      const feedbackSection = document.getElementById('feedbackSection');
      feedbackSection.style.display = 'block';
      document.getElementById('feedback').focus();
    };

    window.tweakMessage = async function() {
      const feedback = document.getElementById('resultsFeedbackInput').value.trim();
      
      if (!feedback) {
        showAlert('Please provide some feedback on how to improve the message', 'error');
        return;
      }
      
      // Store the feedback in the circumstances field
      document.getElementById('circumstances').value = 'FEEDBACK: ' + feedback;
      
      // Generate a new message with the feedback
      await generateMessage(true);
      
      // Reset the feedback input
      document.getElementById('resultsFeedbackInput').value = '';
      document.getElementById('resultsFeedbackForm').style.display = 'none';
    }
    
    // Show feedback form
    window.showFeedback = function() {
      document.getElementById('resultsFeedbackForm').style.display = 'block';
    }

    window.copyMessage = function() {
      const messageText = document.getElementById('messageText').textContent;
      navigator.clipboard.writeText(messageText).then(() => {
        showAlert('Message copied to clipboard!', 'success');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showAlert('Failed to copy message', 'error');
      });
    };

    // Global function for showing alerts
    function showAlert(message, type = 'error') {
      const alertEl = document.createElement('div');
      alertEl.style.position = 'fixed';
      alertEl.style.top = '20px';
      alertEl.style.left = '50%';
      alertEl.style.transform = 'translateX(-50%)';
      alertEl.style.padding = '12px 24px';
      alertEl.style.borderRadius = '8px';
      alertEl.style.color = 'white';
      alertEl.style.zIndex = '1000';
      alertEl.style.maxWidth = '90%';
      alertEl.style.textAlign = 'center';
      alertEl.style.animation = 'slideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
      alertEl.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
      alertEl.style.backdropFilter = 'blur(8px)';
      
      if (type === 'error') {
        alertEl.style.backgroundColor = 'rgba(255, 87, 87, 0.9)';
      } else if (type === 'success') {
        alertEl.style.backgroundColor = 'rgba(88, 214, 141, 0.9)';
      } else {
        alertEl.style.backgroundColor = 'rgba(52, 152, 219, 0.9)';
      }
      
      alertEl.textContent = message;
      document.body.appendChild(alertEl);
      
      setTimeout(() => {
        alertEl.style.transform = 'translateX(-50%) translateY(-20px)';
        alertEl.style.opacity = '0';
        alertEl.style.transition = 'all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        setTimeout(() => {
          document.body.removeChild(alertEl);
        }, 300);
      }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the app first
      initializeApp();

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBZiJPTs7dMccVgFV-YoTejnhy1bZNFEQY",
        authDomain: "heartglowai.firebaseapp.com",
        projectId: "heartglowai",
        storageBucket: "heartglowai.firebasestorage.app",
        messagingSenderId: "196565711798",
        appId: "1:196565711798:web:79e2b0320fd8e74ab0df17",
        measurementId: "G-KJMPL1DNPY"
      };
      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      
      // Initialize Firebase Analytics
      const analytics = firebase.analytics();
      
      // Track page view
      analytics.logEvent('page_view', {
        page_title: document.title,
        page_location: window.location.href
      });
      
      // Get elements
      const loginRegisterBtn = document.getElementById('login-register-btn');
      
      const authForm = document.getElementById('auth-form');
      const authSubmitBtn = document.getElementById('auth-submit-btn');
      const authToggleText = document.getElementById('auth-toggle-text');
      const authToggleLink = document.getElementById('auth-toggle-link');
      const forgotPasswordLink = document.getElementById('forgot-password-link');
      
      const newConversationBtn = document.getElementById('new-conversation-btn');
      const templateCards = document.querySelectorAll('.template-card');
      const settingsBtn = document.getElementById('history-btn');
      const logoutBtn = document.getElementById('logout-btn');
      
      const backToHomeBtn = document.getElementById('back-to-home-btn');
      const scenarioInput = document.getElementById('scenario');
      const relationshipSelect = document.getElementById('relationship');
      const generateBtn = document.getElementById('generateBtn');
      const loadingSpinner = document.getElementById('loading');
      const resultCard = document.getElementById('result');
      const resultMessage = document.getElementById('messageText');
      
      // Storage keys
      const STORAGE_KEYS = {
        USER_SETTINGS: 'user_settings',
        MESSAGE_HISTORY: 'message_history'
      };
      
      // Constants
      const RELATIONSHIP_TYPES = [
        "Romantic Partner",
        "Friend",
        "Family Member",
        "Professional Contact"
      ];
      
      // Auth state
      let isLogin = true;
      let openaiApiKey = null;
      
      // Check auth state
      firebase.auth().onAuthStateChanged(async (user) => {
        currentUser = user;
        
        if (user) {
          // Initialize user document if it doesn't exist
          const userRef = firebase.firestore().collection('users').doc(user.uid);
          const userDoc = await userRef.get();
          
          if (!userDoc.exists) {
            await userRef.set({
              email: user.email,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              messageCount: 0,
              hasFeedbackSubmitted: false,
              lastFeedbackSubmittedAt: null,
              feedbackData: null
            });
          }
          
          // Check feedback status
          await checkFeedbackStatus();
          
          showScreen(homeScreen);
          
          // Ensure template clicks work after auth state is determined
          attachTemplateClickListeners();
        } else {
          showScreen(welcomeScreen);
        }
      });
      
      // Function to attach template click listeners
      function attachTemplateClickListeners() {
        const templateCards = document.querySelectorAll('.template-card');
        console.log('Attaching template listeners to', templateCards.length, 'cards');
        
        templateCards.forEach(card => {
          const templateType = card.getAttribute('data-template');
          
          // Remove any existing listeners to prevent duplicates
          const newCard = card.cloneNode(true);
          card.parentNode.replaceChild(newCard, card);
          
          newCard.addEventListener('click', function() {
            console.log('Template clicked:', templateType);
            handleTemplateClick(templateType);
          });
        });
      }
      
      // Event Listeners
      loginRegisterBtn.addEventListener('click', function() {
        showScreen(authScreen);
      });
      
      authToggleLink.addEventListener('click', function(e) {
        e.preventDefault();
        isLogin = !isLogin;
        if (isLogin) {
          authToggleText.textContent = "Don't have an account?";
          authToggleLink.textContent = "Sign up";
          authSubmitBtn.textContent = "Continue";
        } else {
          authToggleText.textContent = "Already have an account?";
          authToggleLink.textContent = "Log in";
          authSubmitBtn.textContent = "Create Account";
        }
      });
      
      forgotPasswordLink.addEventListener('click', function(e) {
        e.preventDefault();
        const email = prompt("Please enter your email address to reset your password:");
        if (email) {
          firebase.auth().sendPasswordResetEmail(email)
            .then(() => {
              showAlert('Password reset email sent!', 'success');
            })
            .catch((error) => {
              showAlert(`Error: ${error.message}`, 'error');
            });
        }
      });
      
      authForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
          showAlert('Please enter both email and password', 'error');
          return;
        }
        
        if (isLogin) {
          // Login
          firebase.auth().signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
              showScreen(homeScreen);
            })
            .catch((error) => {
              showAlert(`Login error: ${error.message}`, 'error');
            });
        } else {
          // Register
          firebase.auth().createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
              // Create user document in Firestore
              firebase.firestore().collection('users').doc(userCredential.user.uid).set({
                email: email,
                createdAt: new Date()
              });
              
              showScreen(homeScreen);
              showAlert('Account created successfully!', 'success');
            })
            .catch((error) => {
              showAlert(`Registration error: ${error.message}`, 'error');
            });
        }
      });
      
      newConversationBtn.addEventListener('click', function() {
        scenarioInput.value = "";
        relationshipSelect.value = "Romantic Partner";
        resultCard.style.display = "none";
        showScreen(generatorScreen);
      });
      
      // Enhanced template presets
      const templates = {
        apology: {
          scenario: "I need to apologize to someone for missing an important event",
          relationship: "Friend",
          tone: "sincere",
          intensity: "4",
          duration: "few months",
          circumstances: "I missed their birthday celebration due to work commitments"
        },
        romantic: {
          scenario: "I want to express my love and appreciation to my partner",
          relationship: "Romantic Partner",
          tone: "poetic",
          intensity: "5",
          duration: "1-5 years",
          circumstances: "We recently celebrated our anniversary"
        },
        tough: {
          scenario: "I need to have a difficult conversation about boundaries",
          relationship: "Friend",
          tone: "formal",
          intensity: "3",
          duration: "few months",
          circumstances: "There have been some misunderstandings about personal space"
        },
        checkin: {
          scenario: "I want to check in with someone I haven't spoken to in a while",
          relationship: "Family Member",
          tone: "casual",
          intensity: "2",
          duration: "5+ years",
          circumstances: "We've been busy with our own lives but I miss them"
        },
        gratitude: {
          scenario: "I want to express deep gratitude for someone's support during a difficult time",
          relationship: "Friend",
          tone: "sincere",
          intensity: "4",
          duration: "1-5 years",
          circumstances: "They helped me through a challenging period in my life"
        },
        celebration: {
          scenario: "I want to congratulate someone on their recent achievement",
          relationship: "Professional",
          tone: "enthusiastic",
          intensity: "4",
          duration: "few months",
          circumstances: "They recently got promoted/completed a major project"
        },
        encouragement: {
          scenario: "I want to encourage someone who is facing a challenge",
          relationship: "Friend",
          tone: "supportive",
          intensity: "4",
          duration: "1-5 years",
          circumstances: "They're going through a difficult transition"
        },
        sympathy: {
          scenario: "I want to express sympathy and support during their loss",
          relationship: "Family Member",
          tone: "compassionate",
          intensity: "3",
          duration: "lifelong",
          circumstances: "They recently lost a loved one"
        }
      };

      // Enhanced feedback submission
      async function handleFeedbackSubmit() {
        const formData = {
          email: document.getElementById('feedbackEmail').value,
          userType: document.getElementById('feedbackUserType').value,
          messageQuality: document.querySelector('input[name="messageQuality"]:checked')?.value,
          easeOfUse: document.querySelector('input[name="easeOfUse"]:checked')?.value,
          features: Array.from(document.querySelectorAll('input[name="features"]:checked')).map(cb => cb.value),
          strengths: document.getElementById('feedbackStrengths').value.trim(),
          improvements: document.getElementById('feedbackImprovements').value.trim(),
          featureRequests: document.getElementById('feedbackFeatures').value.trim(),
          npsScore: document.getElementById('npsScore').value,
          timestamp: new Date().toISOString()
        };

        if (!formData.messageQuality || !formData.easeOfUse || !formData.strengths) {
          showAlert('Please fill in the star ratings and what you liked most', 'error');
          return;
        }

        try {
          const response = await fetch('https://formspree.io/f/xwplnpbl', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
          });

          if (response.ok) {
            if (currentUser) {
              // Update user document with feedback data but don't mark as submitted
              await firebase.firestore().collection('users').doc(currentUser.uid).update({
                lastFeedbackSubmittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                feedbackData: formData
              });
            }

            showAlert('Thank you for your detailed feedback!', 'success');
            hideFeedbackModal();
            
            // Reset form
            document.getElementById('feedbackForm').reset();
          } else {
            throw new Error('Failed to submit feedback');
          }
        } catch (error) {
          console.error('Feedback submission error:', error);
          showAlert('Failed to submit feedback. Please try again.', 'error');
        }
      }

      // Template card click handler
      function handleTemplateClick(templateType) {
        const template = templates[templateType];
        if (template) {
          document.getElementById('scenario').value = template.scenario;
          document.getElementById('relationship').value = template.relationship;
          document.getElementById('tone').value = template.tone;
          document.getElementById('intensity').value = template.intensity;
          document.getElementById('duration').value = template.duration;
          document.getElementById('circumstances').value = template.circumstances;
          document.getElementById('result').style.display = "none";
          showScreen(generatorScreen);
        }
      }

      // Add template click listeners
      document.addEventListener('DOMContentLoaded', function() {
        // Attach template click listeners on initial load
        attachTemplateClickListeners();
      });
      
      backToHomeBtn.addEventListener('click', function() {
        if (currentUser) {
          showScreen(homeScreen);
        } else {
          showScreen(welcomeScreen);
        }
      });
      
      settingsBtn.addEventListener('click', async function() {
        if (!currentUser) {
          showAlert('Please log in to view message history', 'error');
          return;
        }
        
        try {
          const messagesRef = firebase.firestore()
            .collection('users')
            .doc(currentUser.uid)
            .collection('messages')
            .orderBy('timestamp', 'desc')
            .limit(10);
            
          const snapshot = await messagesRef.get();
          
          if (snapshot.empty) {
            showAlert('No messages in history yet', 'info');
            return;
          }
          
          // Create and show history modal
          const modal = document.createElement('div');
          modal.style.position = 'fixed';
          modal.style.top = '50%';
          modal.style.left = '50%';
          modal.style.transform = 'translate(-50%, -50%)';
          modal.style.backgroundColor = 'var(--card-bg)';
          modal.style.padding = '20px';
          modal.style.borderRadius = '16px';
          modal.style.maxWidth = '90%';
          modal.style.width = '400px';
          modal.style.maxHeight = '80vh';
          modal.style.overflowY = 'auto';
          modal.style.zIndex = '1000';
          
          // Add close button
          const closeBtn = document.createElement('button');
          closeBtn.textContent = '×';
          closeBtn.style.position = 'absolute';
          closeBtn.style.right = '10px';
          closeBtn.style.top = '10px';
          closeBtn.style.background = 'none';
          closeBtn.style.border = 'none';
          closeBtn.style.color = 'white';
          closeBtn.style.fontSize = '24px';
          closeBtn.style.cursor = 'pointer';
          closeBtn.onclick = () => modal.remove();
          modal.appendChild(closeBtn);
          
          // Add title
          const title = document.createElement('h2');
          title.textContent = 'Message History';
          title.style.marginBottom = '20px';
          title.style.fontSize = '20px';
          title.style.fontWeight = '600';
          modal.appendChild(title);
          
          // Add messages
          snapshot.forEach(doc => {
            const data = doc.data();
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '20px';
            messageDiv.style.padding = '15px';
            messageDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            messageDiv.style.borderRadius = '8px';
            
            const header = document.createElement('div');
            header.style.marginBottom = '10px';
            header.style.fontSize = '14px';
            header.style.color = 'var(--text-secondary)';
            header.textContent = `${data.relationshipType} - ${new Date(data.timestamp.toDate()).toLocaleDateString()}`;
            messageDiv.appendChild(header);
            
            const scenario = document.createElement('div');
            scenario.style.marginBottom = '10px';
            scenario.style.fontSize = '14px';
            scenario.style.fontStyle = 'italic';
            scenario.textContent = data.scenario;
            messageDiv.appendChild(scenario);
            
            const message = document.createElement('div');
            message.style.fontSize = '15px';
            message.style.lineHeight = '1.5';
            message.textContent = data.message;
            messageDiv.appendChild(message);
            
            modal.appendChild(messageDiv);
          });
          
          // Add overlay
          const overlay = document.createElement('div');
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100%';
          overlay.style.height = '100%';
          overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
          overlay.style.zIndex = '999';
          overlay.onclick = () => {
            modal.remove();
            overlay.remove();
          };
          
          document.body.appendChild(overlay);
          document.body.appendChild(modal);
          
        } catch (error) {
          console.error('Error fetching message history:', error);
          showAlert('Error loading message history', 'error');
        }
      });
      
      logoutBtn.addEventListener('click', function() {
        if (confirm("Are you sure you want to log out?")) {
          firebase.auth().signOut()
            .then(() => {
              showScreen(welcomeScreen);
              showAlert('Logged out successfully', 'success');
            })
            .catch((error) => {
              showAlert(`Error logging out: ${error.message}`, 'error');
            });
        }
      });
      
      // Update the generateMessage function to store the current message
      generateBtn.addEventListener('click', async function() {
        // Show animation immediately
        showGenerateAnimation();
        
        // Track message generation attempt
        analytics.logEvent('generate_message', {
          relationship_type: relationshipSelect.value
        });
        
        const scenario = document.getElementById('scenario').value.trim();
        const relationship = document.getElementById('relationship').value;
        const tone = document.getElementById('tone').value;
        const intensity = document.getElementById('intensity').value;
        const duration = document.getElementById('duration').value;
        const circumstances = document.getElementById('circumstances').value.trim();
        
        if (!scenario) {
          showAlert("Please enter a communication scenario", 'error');
          return;
        }
        
        if (!currentUser) {
          showAlert("Please sign in to generate messages", 'error');
          return;
        }
        
        // Show the loading overlay with context about the message being generated
        updateLoadingContext(relationship, tone);
        showLoading();
        
        try {
          // Get the current user's ID token
          const idToken = await currentUser.getIdToken();
          
          console.log('Sending request to Cloud Function:', {
            scenario,
            relationshipType: relationship,
            tone,
            toneIntensity: intensity,
            relationshipDuration: duration,
            specialCircumstances: circumstances
          });
          
          const response = await fetch('https://us-central1-heartglowai.cloudfunctions.net/generateMessage', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'Authorization': `Bearer ${idToken}`
            },
            body: JSON.stringify({
              scenario,
              relationshipType: relationship,
              tone,
              toneIntensity: intensity,
              relationshipDuration: duration,
              specialCircumstances: circumstances
            })
          });
          
          console.log('Response status:', response.status);
          const data = await response.json();
          console.log('Response data:', data);
          
          if (!response.ok) {
            throw new Error(data.error || 'Failed to generate message');
          }
          
          if (!data.message) {
            throw new Error('No message received from server');
          }
          
          // Store current message for feedback
          currentMessage = data.message;
          
          // Prepare insights
          const insights = data.insights || [
            "The message uses an appropriate tone for your relationship.",
            "It clearly expresses your intention in a way that respects boundaries.",
            "The language is authentic and connects emotionally."
          ];
          
          // Hide loading
          hideLoading();
          
          // Show results in the popup overlay
          showResults(data.message, insights);
          
          // Try to save to history in the background
          if (currentUser) {
            saveMessage(scenario, relationship, data.message).catch(console.error);
          }
          
          // After successful message generation, update message count
          await updateMessageCount();
        } catch (error) {
          // Hide loading
          hideLoading();
          
          console.error('Error details:', {
            error: error,
            message: error.message,
            stack: error.stack,
            name: error.name
          });
          
          if (error.response) {
            console.error('Response error:', {
              status: error.response.status,
              data: error.response.data,
              headers: error.response.headers
            });
          }
          
          // Enhanced error handling
          if (error.message.includes('authenticated')) {
            showAlert('Please sign in to generate messages', 'error');
          } else if (error.message.includes('Failed to fetch') || error.message.includes('Network error')) {
            showAlert('Network error - please check your connection', 'error');
          } else if (error.response?.status === 401) {
            showAlert('Authentication error - please sign in again', 'error');
          } else if (error.response?.status === 403) {
            showAlert('Permission denied - please contact support', 'error');
          } else {
            showAlert(error.message || 'Failed to generate message', 'error');
          }
        }
      });

      // Add Google Sign In functionality
      document.getElementById('google-sign-in').addEventListener('click', function() {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({
          prompt: 'select_account'
        });
        
        firebase.auth()
          .signInWithPopup(provider)
          .then((result) => {
            // Check if it's a new user
            const isNewUser = result.additionalUserInfo.isNewUser;
            
            if (isNewUser) {
              // Create user document in Firestore
              return firebase.firestore().collection('users').doc(result.user.uid).set({
                email: result.user.email,
                displayName: result.user.displayName,
                photoURL: result.user.photoURL,
                createdAt: new Date(),
                authProvider: 'google'
              }).then(() => {
                showAlert('Account created successfully!', 'success');
                showScreen(homeScreen);
              });
            } else {
              showScreen(homeScreen);
            }
          })
          .catch((error) => {
            console.error('Google Sign In Error:', error);
            showAlert(`Error: ${error.message}`, 'error');
          });
      });

      // Check for and redirect to feedback.html after a certain number of messages
      async function checkFeedbackStatus() {
        if (currentUser) {
          try {
            const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
            // Only check for first-time feedback submission
            hasSubmittedFeedback = userDoc.exists && userDoc.data().hasFeedbackSubmitted === true;
            
            if (!hasSubmittedFeedback) {
              // Get stored message count
              messageCount = userDoc.data()?.messageCount || 0;
            }
          } catch (error) {
            console.error('Error checking feedback status:', error);
          }
        }
      }

      // Update the message count in Firestore
      async function updateMessageCount() {
        if (currentUser && !hasSubmittedFeedback) {
          try {
            messageCount++;
            await firebase.firestore().collection('users').doc(currentUser.uid).update({
              messageCount: messageCount
            });

            if (messageCount >= 3) {
              // Instead of showing the modal, suggest visiting the feedback page
              showAlert('We value your feedback! Please click the "Submit Feedback" button when you have a moment.', 'info');
            }
          } catch (error) {
            console.error('Error updating message count:', error);
          }
        }
      }

      // Event Listeners for Feedback
      document.getElementById('feedbackButton').addEventListener('click', function() {
        window.location.href = 'feedback.html';
      });
      document.getElementById('feedbackCancel').addEventListener('click', hideFeedbackModal);
      document.getElementById('feedbackSubmit').addEventListener('click', handleFeedbackSubmit);
      document.getElementById('feedbackOverlay').addEventListener('click', hideFeedbackModal);

      // Update the generateMessage event listener to include feedback tracking
      generateBtn.addEventListener('click', async function() {
        // ... existing generate message code ...
        
        try {
          // ... existing try block code ...
          
          // After successful message generation, update message count
          await updateMessageCount();
          
          // ... rest of the existing code ...
        } catch (error) {
          // ... existing error handling ...
        }
      });
    });

    function showGenerateAnimation() {
      const generateBtn = document.getElementById('generateBtn');
      
      // Add a 'generating' class with animation
      generateBtn.classList.add('generating');
      
      // Create and add the animation span
      const animationSpan = document.createElement('span');
      animationSpan.className = 'generate-animation';
      generateBtn.appendChild(animationSpan);
      
      // Remove after animation completes
      setTimeout(() => {
        generateBtn.classList.remove('generating');
        if (animationSpan && animationSpan.parentNode === generateBtn) {
          generateBtn.removeChild(animationSpan);
        }
      }, 1500);
    }

    // Update the loading context with user variables
    function updateLoadingContext(relationship, tone) {
      const loadingContext = document.getElementById('loadingContext');
      if (!loadingContext) return;
      
      // Craft a loading message based on the relationship and tone
      let message = `Creating a <span class="loading-highlight">${tone}</span> message for your <span class="loading-highlight">${relationship.toLowerCase()}</span>`;
      
      // Add variety based on tone
      switch(tone.toLowerCase()) {
        case 'casual':
          message += "... keeping it relaxed and friendly";
          break;
        case 'formal':
          message += "... with the right level of respect";
          break;
        case 'humorous':
          message += "... with a touch of humor";
          break;
        case 'poetic':
          message += "... with flowing, heartfelt words";
          break;
        case 'serious':
          message += "... with sincerity and depth";
          break;
        default:
          message += "... with the perfect words";
      }
      
      loadingContext.innerHTML = message;
    }
    
    // Show the loading overlay
    function showLoading() {
      console.log('Showing loading overlay');
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        setTimeout(() => {
          loadingOverlay.classList.add('active');
        }, 10);
      } else {
        console.error('Loading overlay element not found');
      }
      
      // Make sure results overlay is hidden when showing loading
      hideResults();
    }
    
    // Hide the loading overlay
    function hideLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.remove('active');
      }
    }
    
    // Results overlay functions
    function showResults(message, insights) {
      console.log('Showing results overlay');
      
      // Ensure old result card is hidden
      const resultCard = document.getElementById('result');
      if (resultCard) {
        resultCard.style.display = 'none';
      }
      
      // Get overlay elements
      const resultsOverlay = document.getElementById('resultsOverlay');
      const resultsMessage = document.getElementById('resultsMessage');
      const insightsList = document.getElementById('resultsInsights');
      
      if (!resultsOverlay || !resultsMessage || !insightsList) {
        console.error('Required results elements not found');
        return;
      }
      
      // Update message
      resultsMessage.textContent = message;
      
      // Clear and update insights
      insightsList.innerHTML = '';
      if (insights && Array.isArray(insights)) {
        insights.forEach(insight => {
          const li = document.createElement('li');
          li.className = 'insight-item';
          li.textContent = insight;
          insightsList.appendChild(li);
        });
      }
      
      // Show overlay with animation
      resultsOverlay.style.display = 'flex';
      // Force reflow
      resultsOverlay.offsetHeight;
      resultsOverlay.classList.add('active');
      
      // Add escape key listener
      document.addEventListener('keydown', function escapeHandler(e) {
        if (e.key === 'Escape') {
          hideResults();
          document.removeEventListener('keydown', escapeHandler);
        }
      });
      
      // Add click outside listener
      resultsOverlay.addEventListener('click', function overlayClickHandler(e) {
        if (e.target === resultsOverlay) {
          hideResults();
          resultsOverlay.removeEventListener('click', overlayClickHandler);
        }
      });
    }
    
    function hideResults() {
      console.log('Hiding results overlay');
      const resultsOverlay = document.getElementById('resultsOverlay');
      if (!resultsOverlay) return;
      
      resultsOverlay.classList.remove('active');
      
      // Wait for animation to complete before hiding
      setTimeout(() => {
        if (!resultsOverlay.classList.contains('active')) {
          resultsOverlay.style.display = 'none';
        }
      }, 400); // Match the CSS transition duration
    }
    
    // Update the generateMessage function to use the helper
    window.generateMessage = async function(isRetry = false) {
      const scenario = document.getElementById('scenario').value.trim();
      const relationship = document.getElementById('relationship').value;
      const tone = document.getElementById('tone').value;
      const intensity = document.getElementById('intensity').value;
      const duration = document.getElementById('duration').value;
      const circumstances = document.getElementById('circumstances').value.trim();

      // Input validation
      if (!scenario) {
        showAlert('Please describe what you would like to say', 'error');
        return;
      }

      // Show loading animation
      updateLoadingContext(relationship, tone);
      showLoading();

      try {
        const requestData = {
          scenario,
          relationshipType: relationship,
          tone,
          toneIntensity: intensity,
          relationshipDuration: duration,
          specialCircumstances: circumstances,
          retry: isRetry
        };

        const data = await makeApiRequest(API_CONFIG.ENDPOINTS.GENERATE, requestData);
        
        // Hide loading first
        hideLoading();
        
        if (data.message) {
          // Prepare insights
          const insights = data.insights || [
            "The message uses an appropriate tone for your relationship",
            "It clearly expresses your intention while respecting boundaries",
            "The language is authentic and connects emotionally"
          ];
          
          // Show results in popup
          showResults(data.message, insights);
          
          // Store current message for feedback
          currentMessage = data.message;
          
          // Try to save to history in the background
          if (currentUser) {
            saveMessage(scenario, relationship, data.message).catch(console.error);
          }
        } else {
          throw new Error('No message received from server');
        }
      } catch (error) {
        console.error('Error generating message:', error);
        
        // Hide loading
        hideLoading();
        
        // Show appropriate error message
        if (error.message.includes('Unable to connect')) {
          showAlert('Unable to connect to the server. Please check your connection and try again.', 'error');
        } else if (error.message.includes('Access denied')) {
          showAlert('Access denied. Please try logging in again.', 'error');
        } else if (error.message.includes('Too many requests')) {
          showAlert('We\'re experiencing high demand. Please try again in a moment.', 'error');
        } else {
          showAlert(error.message || 'Failed to generate message. Please try again.', 'error');
        }
      }
    };

    // Add event listeners for results overlay
    document.addEventListener('DOMContentLoaded', function() {
      // Setup results overlay listeners
      const closeResults = document.getElementById('closeResults');
      if (closeResults) {
        closeResults.addEventListener('click', hideResults);
      }
      
      // Copy button functionality
      const resultsCopyBtn = document.getElementById('resultsCopyBtn');
      if (resultsCopyBtn) {
        resultsCopyBtn.addEventListener('click', function() {
          const messageText = document.getElementById('resultsMessage').textContent;
          navigator.clipboard.writeText(messageText).then(function() {
            showAlert('Message copied to clipboard!', 'success');
          }).catch(function(err) {
            console.error('Could not copy text: ', err);
            showAlert('Failed to copy message', 'error');
          });
        });
      }
      
      // Tweak button functionality
      const resultsTweakBtn = document.getElementById('resultsTweakBtn');
      if (resultsTweakBtn) {
        resultsTweakBtn.addEventListener('click', function() {
          document.getElementById('resultsFeedbackForm').style.display = 'block';
        });
      }
      
      // Submit feedback button
      const resultsSubmitFeedback = document.getElementById('resultsSubmitFeedback');
      if (resultsSubmitFeedback) {
        resultsSubmitFeedback.addEventListener('click', function() {
          tweakMessage();
        });
      }
      
      // Ensure the Generate button calls the generateMessage function
      const generateBtn = document.getElementById('generateBtn');
      if (generateBtn) {
        // Remove any existing listeners
        const newBtn = generateBtn.cloneNode(true);
        generateBtn.parentNode.replaceChild(newBtn, generateBtn);
        
        // Add new listener
        newBtn.addEventListener('click', function() {
          generateMessage();
        });
      }
    });

    async function submitFeedback(rating, comment) {
      if (!currentMessage) {
        showAlert('No message to provide feedback for', 'error');
        return;
      }

      try {
        const requestData = {
          message: currentMessage,
          rating: parseInt(rating),
          comment: comment || ''
        };

        await makeApiRequest(API_CONFIG.ENDPOINTS.FEEDBACK, requestData);
        
        // Mark feedback as submitted
        hasSubmittedFeedback = true;
        
        // Close the modal
        const modal = document.getElementById('feedbackModal');
        modal.style.display = 'none';
        
        // Show success message
        showAlert('Thank you for your feedback!', 'success');
      } catch (error) {
        console.error('Error submitting feedback:', error);
        showAlert('Failed to submit feedback. Please try again.', 'error');
      }
    }
  </script>
</body>
</html> 