(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[843],{1247:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/coaching/[threadId]",function(){return r(9244)}])},8477:function(e,t,r){"use strict";r.d(t,{db:function(){return o},l:function(){return i}});var a=r(3977),s=r(9451),n=r(6100);let i=(0,a.C6)().length?(0,a.C6)()[0]:(0,a.ZF)({apiKey:"AIzaSyBZiJPTs7dMccVgFV-YoTejnhy1bZNFEQY",authDomain:"heartglowai.firebaseapp.com",projectId:"heartglowai",storageBucket:"heartglowai.firebasestorage.app",messagingSenderId:"196565711798",appId:"1:196565711798:web:79e2b0320fd8e74ab0df17",measurementId:"G-KJMPL1DNPY"});(0,s.v0)(i);let o=(0,n.ad)(i)},9244:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return _threadId_}});var a=r(5893),s=r(7294),n=r(9008),i=r.n(n),o=r(1163),d=r(1810),c=r(9406),l=r(2469),h=r(8549),g=r(8477),u=r(6100),m=r(7004);let f=(0,m.$C)();var coaching_CoachingChatView=e=>{var t;let{threadId:r}=e,{currentUser:n}=(0,h.a)(),[i,o]=(0,s.useState)(null),[d,c]=(0,s.useState)([]),[x,p]=(0,s.useState)(!0),[b,y]=(0,s.useState)(!0),[w,v]=(0,s.useState)(null),[j,k]=(0,s.useState)(""),N=(0,s.useRef)(null);(0,s.useEffect)(()=>{if(!r)return;p(!0),v(null);let e=(0,u.JU)(g.db,"coachingThreads",r);(0,u.QT)(e).then(e=>{if(e.exists()){let t={id:e.id,...e.data()};t.userId===(null==n?void 0:n.uid)?o(t):(v("You don't have permission to view this chat."),console.error("User mismatch for thread access"))}else v("Chat thread not found.")}).catch(e=>{console.error("Error fetching thread data: ",e),v("Failed to load chat details.")}).finally(()=>{p(!1)})},[r,n]),(0,s.useEffect)(()=>{if(!r)return;y(!0),v(null);let e=(0,u.hJ)(g.db,"coachingThreads",r,"messages"),t=(0,u.IO)(e,(0,u.Xo)("timestamp","asc")),a=(0,u.cf)(t,e=>{let t=e.docs.map(e=>({id:e.id,...e.data()}));c(t),y(!1)},e=>{console.error("Error fetching messages: ",e),v("Failed to load messages."),y(!1)});return()=>a()},[r]),(0,s.useEffect)(()=>{var e;null===(e=N.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[d]);let handleSendMessage=async e=>{if(e.preventDefault(),!j.trim()||!n||!r)return;let t=j.trim();k("");try{let e=(0,u.hJ)(g.db,"coachingThreads",r,"messages"),a=await (0,u.ET)(e,{threadId:r,sender:"user",content:t,timestamp:(0,u.Bt)()});console.log("User message saved with ID: ",a.id),console.log("Calling coachingAssistant function...");let s=(0,m.V1)(f,"coachingAssistant");await s({threadId:r,userMessage:t}),console.log("coachingAssistant function called successfully.")}catch(e){console.error("Error sending message or calling function: ",e)}},formatTimestamp=e=>{if(!e)return"";let t=e instanceof u.EK?e.toDate():e;return t.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit",hour12:!0})};return x?(0,a.jsx)("div",{className:"flex justify-center items-center h-full p-6",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-heartglow-pink"})}):w?(0,a.jsxs)("div",{className:"p-6 text-center text-red-600 dark:text-red-400",children:["Error: ",w]}):i?(0,a.jsxs)("div",{className:"flex flex-col h-[calc(100vh-var(--header-height)-var(--footer-height)-2rem)] md:h-[calc(100vh-var(--header-height)-var(--footer-height)-4rem)] bg-white dark:bg-heartglow-deepgray border border-gray-200 dark:border-gray-700 rounded-lg shadow-md overflow-hidden",children:[(0,a.jsx)("div",{className:"p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50",children:(0,a.jsxs)("h2",{className:"text-lg font-semibold text-gray-800 dark:text-gray-200 truncate",children:[i.threadTitle,(null===(t=i.connectionSnapshot)||void 0===t?void 0:t.name)&&(0,a.jsxs)("span",{className:"text-sm font-normal text-gray-500 dark:text-gray-400 ml-2",children:["(Regarding: ",i.connectionSnapshot.name,")"]})]})}),(0,a.jsxs)("div",{className:"flex-grow overflow-y-auto p-4 space-y-4",children:[b?(0,a.jsx)("div",{className:"flex justify-center items-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-heartglow-pink"})}):0===d.length?(0,a.jsx)("p",{className:"text-center text-gray-500 dark:text-gray-400 pt-8",children:"Send a message to start the conversation."}):d.map(e=>(0,a.jsx)("div",{className:"flex ".concat("user"===e.sender?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"p-3 rounded-lg max-w-xs lg:max-w-md shadow-sm ".concat("user"===e.sender?"bg-heartglow-pink/90 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100"),children:[(0,a.jsx)("p",{className:"text-sm",children:e.content}),(0,a.jsx)("p",{className:"text-xs mt-1 ".concat("user"===e.sender?"text-pink-100/80":"text-gray-500 dark:text-gray-400"),children:formatTimestamp(e.timestamp)})]})},e.id)),(0,a.jsx)("div",{ref:N})]}),(0,a.jsx)("div",{className:"p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50",children:(0,a.jsxs)("form",{onSubmit:handleSendMessage,className:"flex items-center space-x-3",children:[(0,a.jsx)("input",{type:"text",placeholder:"Talk to your coach...",value:j,onChange:e=>k(e.target.value),className:"flex-grow bg-white text-gray-900 border border-gray-300 rounded-md p-3 placeholder-gray-400 focus:ring-2 focus:ring-heartglow-pink focus:border-transparent dark:bg-gray-700 dark:text-heartglow-offwhite dark:border-gray-600 dark:placeholder-gray-400","aria-label":"Message input",disabled:x||b}),(0,a.jsx)("button",{type:"submit",disabled:!j.trim()||x||b,"aria-label":"Send message",className:"shrink-0 inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-heartglow-pink ".concat(!j.trim()||x||b?"bg-gray-400 dark:bg-gray-600 cursor-not-allowed":"bg-heartglow-pink hover:bg-heartglow-pink/90"),children:(0,a.jsx)(l.kcA,{className:"h-5 w-5"})})]})})]}):(0,a.jsx)("div",{className:"p-6 text-center text-gray-500 dark:text-gray-400",children:"Chat not found or access denied."})},_threadId_=()=>{let e=(0,o.useRouter)(),{threadId:t}=e.query;return t&&"string"==typeof t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(i(),{children:[(0,a.jsx)("title",{children:"HeartGlow AI | Coaching Chat"}),(0,a.jsx)("meta",{name:"description",content:"AI coaching chat for thread ".concat(t)})]}),(0,a.jsx)(c.Z,{children:(0,a.jsx)(d.Z,{children:(0,a.jsx)(coaching_CoachingChatView,{threadId:t})})})]}):(0,a.jsx)(c.Z,{children:(0,a.jsx)(d.Z,{children:(0,a.jsx)("div",{className:"p-6 text-center",children:"Loading chat or invalid thread ID..."})})})}}},function(e){e.O(0,[409,424,4,270,774,888,179],function(){return e(e.s=1247)}),_N_E=e.O()}]);