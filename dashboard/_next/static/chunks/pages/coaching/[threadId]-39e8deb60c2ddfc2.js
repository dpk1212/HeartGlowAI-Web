(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[843],{1247:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/coaching/[threadId]",function(){return r(9244)}])},8477:function(e,t,r){"use strict";r.d(t,{db:function(){return d},l:function(){return o}});var a=r(3977),s=r(9451),n=r(6100);let o=(0,a.C6)().length?(0,a.C6)()[0]:(0,a.ZF)({apiKey:"AIzaSyBZiJPTs7dMccVgFV-YoTejnhy1bZNFEQY",authDomain:"heartglowai.firebaseapp.com",projectId:"heartglowai",storageBucket:"heartglowai.firebasestorage.app",messagingSenderId:"196565711798",appId:"1:196565711798:web:79e2b0320fd8e74ab0df17",measurementId:"G-KJMPL1DNPY"});(0,s.v0)(o);let d=(0,n.ad)(o)},9244:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return _threadId_}});var a=r(5893),s=r(7294),n=r(9008),o=r.n(n),d=r(1163),i=r(1810),l=r(9406),c=r(2469),h=r(8549),g=r(8477),u=r(6100),m=r(7004);let f=(0,m.$C)();var coaching_CoachingChatView=e=>{var t;let{threadId:r}=e,{currentUser:n}=(0,h.a)(),[o,i]=(0,s.useState)(null),[l,x]=(0,s.useState)([]),[p,b]=(0,s.useState)(!0),[y,w]=(0,s.useState)(!0),[v,j]=(0,s.useState)(null),[k,N]=(0,s.useState)(""),C=(0,s.useRef)(null),I=(0,d.useRouter)(),[_,S]=(0,s.useState)(!1);(0,s.useEffect)(()=>{if(!r)return;b(!0),j(null);let e=(0,u.JU)(g.db,"coachingThreads",r);(0,u.QT)(e).then(e=>{if(e.exists()){let t={id:e.id,...e.data()};t.userId===(null==n?void 0:n.uid)?i(t):(j("You don't have permission to view this chat."),console.error("User mismatch for thread access"))}else j("Chat thread not found.")}).catch(e=>{console.error("Error fetching thread data: ",e),j("Failed to load chat details.")}).finally(()=>{b(!1)})},[r,n]),(0,s.useEffect)(()=>{if(!r)return;w(!0),j(null);let e=(0,u.hJ)(g.db,"coachingThreads",r,"messages"),t=(0,u.IO)(e,(0,u.Xo)("timestamp","asc")),a=(0,u.cf)(t,e=>{let t=e.docs.map(e=>({id:e.id,...e.data()}));x(t),w(!1)},e=>{console.error("Error fetching messages: ",e),j("Failed to load messages."),w(!1)});return()=>a()},[r]),(0,s.useEffect)(()=>{var e;null===(e=C.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[l]);let handleSendMessage=async e=>{if(e.preventDefault(),!k.trim()||!n||!r)return;let t=k.trim();N("");try{let e=(0,u.hJ)(g.db,"coachingThreads",r,"messages"),a=await (0,u.ET)(e,{threadId:r,sender:"user",content:t,timestamp:(0,u.Bt)()});console.log("User message saved with ID: ",a.id),console.log("Calling coachingAssistant function...");let s=(0,m.V1)(f,"coachingAssistant");await s({threadId:r,userMessage:t}),console.log("coachingAssistant function called successfully.")}catch(e){console.error("Error sending message or calling function: ",e)}},formatTimestamp=e=>{if(!e)return"";let t=e instanceof u.EK?e.toDate():e;return t.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit",hour12:!0})},handleDeleteChat=async()=>{if(_)return;let e=window.confirm("Are you sure you want to delete this entire chat thread? This action cannot be undone.");if(e){S(!0),console.log("Attempting to delete thread: ".concat(r));try{let e=(0,m.V1)(f,"deleteCoachingThread"),t=await e({threadId:r});console.log("Delete function result:",t),I.push("/coaching")}catch(e){console.error("Error deleting thread ".concat(r,":"),e),alert("Failed to delete chat: ".concat(e.message||"Unknown error")),S(!1)}}};return p?(0,a.jsx)("div",{className:"flex justify-center items-center h-full p-6",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-heartglow-pink"})}):v?(0,a.jsxs)("div",{className:"p-6 text-center text-red-600 dark:text-red-400",children:["Error: ",v]}):o?(0,a.jsxs)("div",{className:"flex flex-col h-[calc(100vh-var(--header-height)-var(--footer-height)-2rem)] md:h-[calc(100vh-var(--header-height)-var(--footer-height)-4rem)] bg-white dark:bg-heartglow-deepgray border border-gray-200 dark:border-gray-700 rounded-lg shadow-md overflow-hidden",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 sticky top-0 z-10 flex items-center justify-between",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold text-gray-800 dark:text-gray-200 truncate",children:[o.threadTitle,(null===(t=o.connectionSnapshot)||void 0===t?void 0:t.name)&&(0,a.jsxs)("span",{className:"text-sm font-normal text-gray-500 dark:text-gray-400 ml-2",children:["(Regarding: ",o.connectionSnapshot.name,")"]})]}),(0,a.jsx)("button",{onClick:handleDeleteChat,disabled:_,className:"p-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400 transition-colors duration-200 ".concat(_?"opacity-50 cursor-not-allowed":""),"aria-label":"Delete chat thread",children:_?(0,a.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"}):(0,a.jsx)(c.XHJ,{className:"h-5 w-5"})})]}),(0,a.jsxs)("div",{className:"flex-grow overflow-y-auto p-4 md:p-6 space-y-4 bg-white dark:bg-heartglow-deepgray scroll-smooth",children:[y?(0,a.jsx)("div",{className:"flex justify-center items-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-heartglow-pink"})}):0===l.length?(0,a.jsx)("p",{className:"text-center text-gray-500 dark:text-gray-400 pt-8",children:"Send a message to start the conversation."}):l.map(e=>(0,a.jsx)("div",{className:"flex ".concat("user"===e.sender?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"py-2 px-4 rounded-2xl max-w-sm md:max-w-md lg:max-w-lg shadow-sm ".concat("user"===e.sender?"bg-gradient-to-br from-heartglow-pink to-heartglow-violet text-white rounded-br-none":"bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-bl-none"),children:[(0,a.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:e.content}),(0,a.jsx)("p",{className:"text-xs mt-1 text-right ".concat("user"===e.sender?"text-pink-100/80":"text-gray-500 dark:text-gray-400"),children:formatTimestamp(e.timestamp)})]})},e.id)),(0,a.jsx)("div",{ref:C})]}),(0,a.jsx)("div",{className:"p-3 md:p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50",children:(0,a.jsxs)("form",{onSubmit:handleSendMessage,className:"flex items-center space-x-3",children:[(0,a.jsx)("input",{type:"text",placeholder:"Talk to your coach...",value:k,onChange:e=>N(e.target.value),className:"flex-grow bg-white dark:bg-gray-700 text-gray-900 dark:text-heartglow-offwhite border border-gray-300 dark:border-gray-600 rounded-lg p-3 placeholder-gray-400 dark:placeholder-gray-400 focus:ring-2 focus:ring-heartglow-pink focus:border-transparent text-sm","aria-label":"Message input",disabled:p||y}),(0,a.jsx)("button",{type:"submit",disabled:!k.trim()||p||y,"aria-label":"Send message",className:"shrink-0 inline-flex items-center justify-center px-4 h-12 w-12 rounded-full text-white transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-heartglow-pink dark:focus:ring-offset-gray-800 ".concat(!k.trim()||p||y?"bg-gray-400 dark:bg-gray-600 cursor-not-allowed":"bg-gradient-to-br from-heartglow-pink to-heartglow-violet hover:from-heartglow-violet hover:to-heartglow-indigo shadow-md hover:shadow-lg"),children:(0,a.jsx)(c.kcA,{className:"h-5 w-5"})})]})})]}):(0,a.jsx)("div",{className:"p-6 text-center text-gray-500 dark:text-gray-400",children:"Chat not found or access denied."})},_threadId_=()=>{let e=(0,d.useRouter)(),{threadId:t}=e.query;return t&&"string"==typeof t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(o(),{children:[(0,a.jsx)("title",{children:"HeartGlow AI | Coaching Chat"}),(0,a.jsx)("meta",{name:"description",content:"AI coaching chat for thread ".concat(t)})]}),(0,a.jsx)(l.Z,{children:(0,a.jsx)(i.Z,{children:(0,a.jsx)(coaching_CoachingChatView,{threadId:t})})})]}):(0,a.jsx)(l.Z,{children:(0,a.jsx)(i.Z,{children:(0,a.jsx)("div",{className:"p-6 text-center",children:"Loading chat or invalid thread ID..."})})})}},1163:function(e,t,r){e.exports=r(9974)}},function(e){e.O(0,[409,664,4,270,774,888,179],function(){return e(e.s=1247)}),_N_E=e.O()}]);