<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HeartGlowAI</title>
  <meta name="description" content="AI-powered heartfelt message generator for all your relationships. Create authentic messages for loved ones.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #ff6b9d 0%, #64d2ff 100%);
      --bg-dark: #050A14;
      --card-bg: #101426;
      --text-primary: #FFFFFF;
      --text-secondary: #B7BAC1;
      --accent-pink: #ff6b9d;
      --accent-blue: #64d2ff;
      --accent-purple: #9460fb;
      --border-color: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(255, 255, 255, 0.05);
      --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --box-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      overscroll-behavior: none;
    }
    
    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 480px;
      margin: 0 auto;
      position: relative;
    }
    
    .screen {
      display: none;
      flex-direction: column;
      height: 100%;
      padding: 20px;
      opacity: 0;
      transform: scale(0.98) translateY(10px);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .screen.active {
      display: flex;
      opacity: 1;
      transform: scale(1) translateY(0);
      pointer-events: all;
    }
    
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      padding-top: 20px;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
    }
    
    .logo-heart {
      width: 36px;
      height: 36px;
      margin-right: 10px;
      background: var(--primary-gradient);
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
      animation: glow 4s ease-in-out infinite alternate;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 700;
    }
    
    /* Welcome Screen */
    .welcome-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
      background-color: var(--bg-dark);
      position: relative;
      overflow: hidden;
    }
    
    .welcome-content {
      max-width: 600px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
      animation: fadeIn 1s ease-out;
      position: relative;
      z-index: 1;
    }
    
    .welcome-heart {
      width: 180px;
      height: 180px;
      margin-bottom: 60px;
      position: relative;
      animation: float 6s ease-in-out infinite;
    }
    
    .welcome-heart svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 0 10px rgba(255, 107, 157, 0.5)) 
              drop-shadow(0 0 20px rgba(100, 210, 255, 0.3));
    }
    
    .welcome-heart path {
      stroke: url(#heartGradient);
      stroke-width: 2.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 1500;
      stroke-dashoffset: 1500;
      animation: drawHeart 2s ease-out forwards;
    }
    
    .welcome-title {
      background-image: var(--primary-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }
    
    .welcome-subtitle {
      color: var(--text-secondary);
      font-size: 24px;
      margin-bottom: 40px;
      text-align: center;
      max-width: 600px;
      line-height: 1.5;
    }
    
    .trust-badge {
      font-size: 14px;
      color: var(--text-secondary);
      opacity: 0.8;
      text-align: center;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      width: 100%;
      max-width: 400px;
    }
    
    #login-register-btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 100px;
      cursor: pointer;
      width: 100%;
      max-width: 300px;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth);
    }
    
    #login-register-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }
    
    #login-register-btn:active {
      transform: scale(0.98);
    }
    
    /* Animated background for welcome screen */
    .welcome-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 20%, rgba(255, 107, 157, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(100, 210, 255, 0.05) 0%, transparent 50%);
      animation: gradientMove 20s ease-in-out infinite alternate;
      z-index: 0;
    }
    
    @keyframes drawHeart {
      to {
        stroke-dashoffset: 0;
      }
    }
    
    /* Auth Screen */
    .auth-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      align-items: center;
      justify-content: center;
    }
    
    .auth-logo {
      width: 60px;
      height: 60px;
      margin-bottom: 40px;
      background: var(--primary-gradient);
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
    }
    
    .auth-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 40px;
    }
    
    .auth-form {
      width: 100%;
      max-width: 320px;
    }
    
    .input-label {
      display: block;
      font-size: 15px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .input-field, select, textarea {
      width: 100%;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      color: white;
      margin-bottom: 20px;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
      backdrop-filter: blur(8px);
    }
    
    .input-field::placeholder, select option, textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .input-field:focus, select:focus, textarea:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(100, 210, 255, 0.2);
      outline: none;
      animation: focusPulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    
    .auth-links {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 320px;
      margin-top: 16px;
    }
    
    .auth-link {
      color: var(--accent-blue);
      text-decoration: none;
      font-size: 14px;
    }
    
    /* Home Screen */
    .home-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .home-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1.2;
    }
    
    .home-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
    }
    
    .home-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      gap: 12px;
    }
    
    .section-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      color: var(--text-primary);
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .section-title:after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-color);
      margin-left: 15px;
    }
    
    .settings-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      border-radius: 12px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background-color var(--transition-fast);
      flex: 1;
    }
    
    .settings-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .settings-icon {
      margin-right: 8px;
      font-size: 16px;
    }
    
    .new-conversation-btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 18px 16px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 30px;
      text-align: center;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth), filter var(--transition-smooth);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .new-conversation-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      filter: brightness(1.05);
    }
    
    .new-conversation-btn:active {
      transform: translateY(1px) scale(0.98);
    }
    
    .new-conversation-icon {
      margin-right: 10px;
      font-size: 20px;
    }
    
    .templates-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .templates-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 480px) {
      .templates-grid {
        grid-template-columns: 1fr;
      }
      
      .template-card {
        padding: 20px 16px;
      }
    }
    
    .templates-section {
      margin-top: 10px;
    }
    
    .template-card {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 24px 20px;
      text-align: center;
      cursor: pointer;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth), background-color var(--transition-smooth);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .template-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: var(--box-shadow-hover);
      background-color: rgba(255, 255, 255, 0.03);
    }
    
    .template-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 14px;
      font-size: 24px;
      background: linear-gradient(135deg, rgba(255, 107, 157, 0.1) 0%, rgba(100, 210, 255, 0.1) 100%);
    }
    
    .template-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .template-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    .template-category {
      margin-top: 36px;
      margin-bottom: 16px;
    }
    
    .category-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }
    
    .category-title::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 14px;
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
      margin-right: 10px;
      border-radius: 2px;
    }
    
    .template-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, 
        rgba(255, 107, 157, 0.1) 0%, 
        rgba(100, 210, 255, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .template-card:hover::before {
      opacity: 1;
    }
    
    .template-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 12px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform var(--transition-fast);
    }
    
    .template-icon.apology {
      background-color: #4A5AEF;
    }
    
    .template-icon.romantic {
      background-color: #FF4B91;
    }
    
    .template-icon.tough {
      background-color: #FF5C5C;
    }
    
    .template-icon.checkin {
      background-color: #9747FF;
    }
    
    .template-name {
      font-size: 15px;
      font-weight: 500;
    }
    
    .template-card:hover .template-icon {
      transform: scale(1.1);
    }
    
    /* Message Generator Screen */
    .generator-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .back-button {
      display: flex;
      align-items: center;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 16px;
      cursor: pointer;
      padding: 0;
      margin-bottom: 20px;
    }
    
    .back-icon {
      margin-right: 8px;
    }
    
    .scenario-textarea {
      width: 100%;
      min-height: 120px;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      color: white;
      margin-bottom: 20px;
      resize: none;
    }
    
    .relationship-select {
      width: 100%;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      color: white;
      margin-bottom: 20px;
      appearance: none;
    }
    
    .result-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-top: 20px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s ease, transform 0.4s ease;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .result-card[style*="display: block"] {
      opacity: 1;
      transform: translateY(0);
    }
    
    .message-text {
      font-size: 18px;
      line-height: 1.7;
      margin-bottom: 24px;
      white-space: pre-wrap;
      color: var(--text-primary);
      padding: 5px;
      border-left: 3px solid var(--accent-pink);
      background-color: rgba(255, 255, 255, 0.03);
      padding-left: 15px;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      width: 100%;
    }
    
    .copy-button, .tweak-button {
      all: unset; /* Reset all styles first */
      background: var(--primary-gradient);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      width: 100%;
      height: 44px;
      position: relative;
      overflow: hidden;
    }
    
    .copy-button:hover, .tweak-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }
    
    .copy-button:active, .tweak-button:active {
      transform: scale(0.95) translateY(1px);
      transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .copy-button::after, .tweak-button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    .copy-button:active::after, .tweak-button:active::after {
      animation: ripple 0.5s ease-out;
    }
    
    .feedback-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      display: none;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height var(--transition-smooth), opacity var(--transition-smooth);
    }
    
    .feedback-section[style*="display: block"] {
      max-height: 500px;
      opacity: 1;
    }
    
    .feedback-input {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text-primary);
      margin: 10px 0;
      font-family: inherit;
      resize: vertical;
    }
    
    .feedback-section label {
      display: block;
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .feedback-section .tweak-button {
      width: 100%;
      margin-top: 10px;
    }
    
    .insights-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }
    
    .insights-title {
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .insights-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .insight-item {
      font-size: 0.9em;
      color: var(--text-secondary);
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }
    
    .insight-item:before {
      content: "â€¢";
      position: absolute;
      left: 0;
      color: var(--primary-color);
    }
    
    .loading-spinner {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 40px auto;
      position: relative;
      min-height: 180px;
      text-align: center;
      width: 100%;
    }
    
    .loading-context {
      color: var(--text-primary);
      margin-top: 24px;
      font-size: 16px;
      max-width: 80%;
      text-align: center;
      animation: fadeIn 0.5s ease forwards;
      font-weight: 500;
    }
    
    .loading-highlight {
      color: var(--accent-pink);
      font-weight: 600;
    }
    
    .heart-spinner {
      width: 60px;
      height: 60px;
      position: relative;
      animation: heartBeat 1.2s ease-in-out infinite;
    }
    
    .heart-spinner::before,
    .heart-spinner::after {
      content: "";
      position: absolute;
      top: 0;
      width: 30px;
      height: 50px;
      border-radius: 50px 50px 0 0;
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
    }
    
    .heart-spinner::before {
      left: 0;
      transform: rotate(-45deg);
      transform-origin: 100% 100%;
    }
    
    .heart-spinner::after {
      right: 0;
      transform: rotate(45deg);
      transform-origin: 0 100%;
    }
    
    @keyframes heartBeat {
      0% {
        transform: scale(0.8);
        opacity: 0.7;
      }
      25% {
        transform: scale(1.1);
        opacity: 1;
      }
      50% {
        transform: scale(0.9);
        opacity: 0.9;
      }
      100% {
        transform: scale(0.8);
        opacity: 0.7;
      }
    }
    
    .spinner-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(
        circle,
        rgba(255, 107, 157, 0.3) 0%,
        rgba(100, 210, 255, 0) 70%
      );
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0.5;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 0.2;
      }
      100% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0.5;
      }
    }
    
    /* Message Generation Form */
    .form-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      transform: translateY(20px);
      opacity: 0;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    label {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    select, textarea {
      background-color: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text-primary);
      padding: 12px;
      font-size: 16px;
      font-family: inherit;
    }
    
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    #circumstances {
      min-height: 80px;
    }

    .slider-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--primary-gradient);
      outline: none;
      transition: background var(--transition-fast);
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      border: none;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      color: var(--text-secondary);
      font-size: 12px;
      padding: 0 2px;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(100, 210, 255, 0.4);
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(255, 107, 157, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(100, 210, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, var(--bg-dark) 0%, var(--bg-dark) 100%);
      z-index: -1;
      animation: gradientMove 20s ease-in-out infinite alternate;
    }

    @keyframes gradientMove {
      0% {
        background-position: 0% 0%;
      }
      100% {
        background-position: 100% 100%;
      }
    }

    /* Floating animation for the welcome hero */
    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-20px);
      }
    }

    /* Glowing effect for the logo */
    @keyframes glow {
      0% {
        filter: drop-shadow(0 0 2px rgba(255, 107, 157, 0.5));
      }
      100% {
        filter: drop-shadow(0 0 10px rgba(100, 210, 255, 0.5));
      }
    }

    /* Generator screen animations */
    @keyframes slideUp {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Input field focus animation */
    @keyframes focusPulse {
      0% {
        box-shadow: 0 0 0 2px rgba(100, 210, 255, 0.2);
      }
      50% {
        box-shadow: 0 0 0 4px rgba(100, 210, 255, 0.1);
      }
      100% {
        box-shadow: 0 0 0 2px rgba(100, 210, 255, 0.2);
      }
    }

    /* Enhanced loading animation */
    .loading-spinner::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60px;
      height: 60px;
      margin: -30px 0 0 -30px;
      border-radius: 50%;
      background: var(--primary-gradient);
      opacity: 0.1;
      animation: pulseLoader 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }

    @keyframes pulseLoader {
      0% {
        transform: scale(0.8);
        opacity: 0.1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.2;
      }
      100% {
        transform: scale(0.8);
        opacity: 0.1;
      }
    }

    /* Result card appearance animation */
    .result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg,
        rgba(255, 107, 157, 0.05) 0%,
        rgba(100, 210, 255, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .result-card[style*="display: block"]::before {
      opacity: 1;
    }

    /* Button press effect enhancement */
    .btn:active, .copy-button:active, .tweak-button:active {
      transform: scale(0.95) translateY(1px);
      transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Add Google Sign In button styles */
    .google-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      color: #333;
      border: none;
      border-radius: 100px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin: 20px 0;
      width: 100%;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .google-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }
    
    .google-btn img {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }

    .auth-divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 20px 0;
      color: var(--text-secondary);
    }

    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--border-color);
    }

    .auth-divider span {
      padding: 0 10px;
      font-size: 14px;
    }

    /* Add the neon heart animation styles */
    @keyframes neonPulse {
      0% {
        filter: drop-shadow(0 0 2px rgba(255, 59, 139, 0.8)) 
                drop-shadow(0 0 4px rgba(140, 70, 255, 0.8))
                drop-shadow(0 0 6px rgba(59, 138, 255, 0.8));
      }
      50% {
        filter: drop-shadow(0 0 4px rgba(255, 59, 139, 0.9))
                drop-shadow(0 0 8px rgba(140, 70, 255, 0.9))
                drop-shadow(0 0 12px rgba(59, 138, 255, 0.9));
      }
      100% {
        filter: drop-shadow(0 0 2px rgba(255, 59, 139, 0.8))
                drop-shadow(0 0 4px rgba(140, 70, 255, 0.8))
                drop-shadow(0 0 6px rgba(59, 138, 255, 0.8));
      }
    }

    .neon-heart {
      width: 280px;
      height: 280px;
      margin-bottom: 40px;
      animation: float 6s ease-in-out infinite;
      position: relative;
    }

    .neon-heart svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 0 4px rgba(255, 59, 139, 0.8))
              drop-shadow(0 0 8px rgba(140, 70, 255, 0.8))
              drop-shadow(0 0 12px rgba(59, 138, 255, 0.8));
      animation: neonPulse 2s ease-in-out infinite;
    }

    .neon-heart path {
      stroke-dasharray: 1500;
      stroke-dashoffset: 1500;
      animation: drawHeart 3s ease-out forwards;
    }

    @keyframes drawHeart {
      to {
        stroke-dashoffset: 0;
      }
    }

    /* Feedback Modal Styles */
    .feedback-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 999;
      display: none;
    }

    .feedback-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 92%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      display: none;
    }

    .feedback-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      text-align: center;
    }

    .feedback-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      text-align: center;
    }

    .feedback-section {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .feedback-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .feedback-section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .feedback-input {
      width: 100%;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      color: var(--text-primary);
      margin-bottom: 16px;
      font-size: 14px;
    }

    .feedback-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .star-rating {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-start;
      margin-bottom: 16px;
    }

    .star-rating input {
      display: none;
    }

    .star-rating label {
      font-size: 24px;
      color: var(--text-secondary);
      margin-right: 8px;
      cursor: pointer;
    }

    .star-rating label:hover,
    .star-rating label:hover ~ label,
    .star-rating input:checked ~ label {
      color: var(--accent-pink);
    }

    .checkbox-group {
      margin: 16px 0;
    }

    .checkbox-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .checkbox-options label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
      cursor: pointer;
    }

    .nps-scale {
      margin: 16px 0;
    }

    .nps-slider {
      width: 100%;
      margin: 8px 0;
    }

    .nps-labels {
      display: flex;
      justify-content: space-between;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .feedback-button-container {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .feedback-submit {
      flex: 1;
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--transition-smooth);
    }

    .feedback-cancel {
      flex: 1;
      background-color: var(--input-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--transition-smooth);
    }

    .feedback-button {
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth), background-color var(--transition-smooth);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      font-size: 15px;
    }

    .feedback-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .feedback-icon {
      margin-right: 8px;
      font-size: 16px;
    }

    /* Template Card Additional Styles */
    .template-icon.gratitude {
      background-color: #FFB156;
    }

    .template-icon.celebration {
      background-color: #FF56B1;
    }

    .template-icon.encouragement {
      background-color: #56B4FF;
    }

    .template-icon.sympathy {
      background-color: #A256FF;
    }

    /* Improve the primary button */
    .primary-button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 24px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      margin-bottom: 10px;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                  box-shadow 0.3s ease,
                  filter 0.3s ease;
      position: relative;
      overflow: hidden;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .primary-button:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      filter: brightness(1.05);
    }
    
    .primary-button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .button-content {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      position: relative;
      z-index: 1;
    }
    
    .button-icon {
      margin-left: 10px;
      font-size: 20px;
    }
    
    /* Button click animation */
    .primary-button::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 10%, transparent 70%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform 0.5s, opacity 0.8s;
    }
    
    .primary-button:active::after {
      transform: scale(0, 0);
      opacity: 0.3;
      transition: 0s;
    }
    
    /* Make insights more prominent */
    .insights-section {
      margin-top: 24px;
      padding: 20px;
      border-radius: 12px;
      background: linear-gradient(135deg, 
        rgba(255, 107, 157, 0.07) 0%, 
        rgba(100, 210, 255, 0.07) 100%);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .insights-title {
      font-size: 16px;
      color: var(--text-primary);
      margin-bottom: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
    }
    
    .insights-title::before {
      content: 'ðŸ’¡';
      margin-right: 10px;
      font-size: 18px;
    }
    
    .insight-item {
      font-size: 15px;
      color: var(--text-primary);
      margin-bottom: 12px;
      padding-left: 24px;
      position: relative;
      line-height: 1.5;
    }
    
    .insight-item:before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: var(--accent-blue);
      font-weight: bold;
    }

    .generating {
      position: relative;
      overflow: hidden;
      pointer-events: none;
    }
    
    .generate-animation {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      z-index: 0;
      animation: shimmer 1.5s linear infinite;
    }
    
    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    /* Full-screen loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(5, 10, 20, 0.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
      max-width: 400px;
      width: 100%;
    }
    
    .loading-context {
      color: var(--text-primary);
      margin-top: 30px;
      font-size: 18px;
      line-height: 1.5;
      text-align: center;
      animation: fadeIn 0.5s ease forwards;
      font-weight: 500;
    }
    
    .loading-highlight {
      color: var(--accent-pink);
      font-weight: 700;
    }
    
    /* Professional heart animation */
    .heart-animation {
      position: relative;
      width: 100px;
      height: 100px;
    }
    
    .heart-shape {
      position: absolute;
      width: 100%;
      height: 100%;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 87.5C47.8333 87.5 45.6667 86.6667 43.5 85C23.1667 69.1667 10 53.75 10 35.8333C10 22.5 20 12.5 33.3333 12.5C40.8333 12.5 47.5 16.25 50 21.6667C52.5 16.25 59.1667 12.5 66.6667 12.5C80 12.5 90 22.5 90 35.8333C90 53.75 76.8333 69.1667 56.5 85C54.3333 86.6667 52.1667 87.5 50 87.5Z' fill='url(%23heartGradient)'/%3E%3Cdefs%3E%3ClinearGradient id='heartGradient' x1='10' y1='12.5' x2='90' y2='87.5' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%23ff6b9d'/%3E%3Cstop offset='1' stop-color='%2364d2ff'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E") center/contain no-repeat;
      transform-origin: center;
      opacity: 0.9;
      animation: heartPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes heartPulse {
      0% { transform: scale(0.95); opacity: 0.7; }
      50% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(0.95); opacity: 0.7; }
    }
    
    .heart-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120%;
      height: 120%;
      background: radial-gradient(
        circle,
        rgba(255, 107, 157, 0.3) 0%,
        rgba(100, 210, 255, 0.1) 50%,
        rgba(0, 0, 0, 0) 70%
      );
      border-radius: 50%;
      animation: glowPulse 2s ease-in-out infinite;
    }
    
    .heart-particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-blue) 100%);
      opacity: 0;
      animation: particleRise 3s ease-out infinite;
    }
    
    .particle:nth-child(1) {
      left: 30%;
      top: 60%;
      animation-delay: 0.2s;
    }
    
    .particle:nth-child(2) {
      left: 45%;
      top: 70%;
      animation-delay: 0.5s;
    }
    
    .particle:nth-child(3) {
      left: 60%;
      top: 60%;
      animation-delay: 0.8s;
    }
    
    .particle:nth-child(4) {
      left: 70%;
      top: 50%;
      animation-delay: 1.1s;
    }
    
    .particle:nth-child(5) {
      left: 35%;
      top: 50%;
      animation-delay: 1.4s;
    }
    
    @keyframes particleRise {
      0% { transform: translateY(0) scale(1); opacity: 0; }
      20% { opacity: 0.8; }
      100% { transform: translateY(-60px) scale(0); opacity: 0; }
    }
    
    @keyframes glowPulse {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.3; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.5; }
      100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.3; }
    }

    /* Results Popup Overlay */
    .results-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(5, 10, 20, 0.9);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .results-popup-overlay.active {
      opacity: 1;
      display: flex;
    }

    .results-popup-container {
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.05) 0%,
        rgba(255, 255, 255, 0.02) 100%
      );
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 32px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
      position: relative;
    }

    .results-popup-overlay.active .results-popup-container {
      transform: translateY(0);
    }

    .results-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .results-popup-title {
      color: white;
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .results-popup-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    }

    .results-popup-close:hover {
      color: white;
    }

    .results-popup-message {
      color: white;
      font-size: 16px;
      line-height: 1.7;
      margin-bottom: 24px;
      white-space: pre-wrap;
      background: rgba(255, 255, 255, 0.03);
      padding: 20px;
      border-radius: 12px;
    }

    .results-popup-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }

    .results-popup-copy-btn, 
    .results-popup-tweak-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .results-popup-copy-btn {
      background: rgba(255, 255, 255, 0.08);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .results-popup-copy-btn:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .results-popup-tweak-btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
    }

    .results-popup-tweak-btn:hover {
      filter: brightness(1.1);
    }

    .results-popup-feedback {
      display: none;
      margin-top: 16px;
      margin-bottom: 24px;
    }

    .results-popup-feedback textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      min-height: 100px;
      margin-bottom: 12px;
      resize: vertical;
    }

    .results-popup-insights {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 20px;
    }

    .results-popup-insights-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
    }

    .results-popup-insights-title::before {
      content: 'ðŸ’¡';
      margin-right: 10px;
    }

    .results-popup-insights-list {
      margin: 0;
      padding: 0 0 0 24px;
    }

    .results-popup-insights-list li {
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 12px;
      position: relative;
    }

    .results-popup-insights-list li::before {
      content: 'âœ“';
      position: absolute;
      left: -20px;
      color: var(--accent-pink);
    }

    /* Dashboard Styles */
    .dashboard-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 20px;
      animation: fadeIn 0.5s ease-out;
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .dashboard-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .dashboard-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .dashboard-card {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .dashboard-card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
    }

    .dashboard-card-title .icon {
      margin-right: 8px;
      font-size: 20px;
    }

    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 16px;
    }

    .stat-item {
      background: linear-gradient(135deg, rgba(255, 107, 157, 0.1) 0%, rgba(100, 210, 255, 0.1) 100%);
      border-radius: 12px;
      padding: 16px;
      flex: 1;
      min-width: 120px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .chart-container {
      height: 200px;
      position: relative;
      margin-top: 16px;
      border-radius: 8px;
      overflow: hidden;
      background-color: rgba(255, 255, 255, 0.03);
    }

    .chart-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .message-history-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .message-history-item:last-child {
      border-bottom: none;
    }

    .message-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      background-color: rgba(100, 210, 255, 0.2);
      color: var(--text-primary);
    }

    .message-details {
      flex: 1;
    }

    .message-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .message-meta {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      gap: 16px;
    }

    .message-date {
      opacity: 0.7;
    }

    .message-relationship {
      opacity: 0.7;
    }

    .dashboard-btn {
      background-color: var(--card-bg);
      border: none;
      border-radius: 12px;
      color: var(--text-primary);
      padding: 10px 20px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform var(--transition-smooth), box-shadow var(--transition-smooth);
    }

    .dashboard-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow-hover);
    }

    .dashboard-icon {
      margin-right: 8px;
      font-size: 16px;
    }

    .dashboard-actions {
      display: flex;
      justify-content: center;
      margin-top: auto;
      padding-top: 24px;
    }

    /* Tour button styles */
    .tour-btn {
      margin-top: 16px;
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 14px 32px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .tour-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    /* Tour screen styles */
    .tour-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .tour-header {
      display: flex;
      align-items: center;
      padding: 12px 0;
      margin-bottom: 20px;
    }
    
    .tour-hero {
      display: flex;
      flex-direction: column;
      margin: 20px 0 60px;
      position: relative;
      align-items: center;
      text-align: center;
    }
    
    @media (min-width: 992px) {
      .tour-container {
        padding: 0 40px;
      }
      
      .tour-header {
        padding: 20px 0;
        margin-bottom: 40px;
      }
      
      .tour-hero {
        flex-direction: row;
        align-items: flex-start;
        text-align: left;
        margin: 60px 0 100px;
        gap: 60px;
      }
    }
    
    .tour-hero-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      max-width: 100%;
      margin-bottom: 40px;
    }
    
    .tour-hero-right {
      width: 100%;
      max-width: 360px;
      margin: 0 auto;
    }
    
    @media (min-width: 992px) {
      .tour-hero-left {
        flex: 1;
        align-items: flex-start;
        text-align: left;
        margin-bottom: 0;
      }
      
      .tour-hero-right {
        flex: 1;
        max-width: 400px;
        margin: 0;
      }
    }
    
    .tour-neon-heart {
      width: 220px;
      height: 220px;
      margin-bottom: 32px;
      filter: drop-shadow(0 0 12px rgba(255, 107, 157, 0.8));
      animation: floatAnimation 6s ease-in-out infinite;
    }
    
    @media (min-width: 992px) {
      .tour-neon-heart {
        width: 280px;
        height: 280px;
        margin-bottom: 40px;
      }
    }
    
    @keyframes floatAnimation {
      0% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-15px);
      }
      100% {
        transform: translateY(0);
      }
    }
    
    .tour-title {
      font-size: 40px;
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: 20px;
      color: var(--text-primary);
    }
    
    .tour-subtitle {
      font-size: 20px;
      line-height: 1.4;
      color: var(--text-secondary);
      margin-bottom: 32px;
      max-width: 500px;
    }
    
    @media (min-width: 992px) {
      .tour-title {
        font-size: 56px;
        margin-bottom: 24px;
      }
      
      .tour-subtitle {
        font-size: 24px;
        margin-bottom: 48px;
      }
    }
    
    .message-card {
      background: rgba(30, 30, 45, 0.8);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-align: left;
    }
    
    .message-content {
      font-size: 19px;
      line-height: 1.5;
      color: var(--text-primary);
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .message-meta {
      font-size: 14px;
      color: var(--text-secondary);
      font-style: italic;
    }
    
    @media (min-width: 992px) {
      .message-card {
        padding: 30px;
      }
      
      .message-content {
        font-size: 21px;
      }
    }
    
    .tour-cta-button {
      display: inline-block;
      background: rgba(50, 50, 80, 0.9);
      color: white;
      border: none;
      padding: 16px;
      width: 100%;
      text-align: center;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 24px;
      margin-bottom: 12px;
    }
    
    .tour-cta-button:hover {
      background: rgba(60, 60, 100, 0.95);
      transform: translateY(-3px);
    }
    
    .tour-note {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 8px;
    }
    
    @media (min-width: 992px) {
      .tour-cta-button {
        padding: 18px 40px;
        font-size: 18px;
        margin-top: 30px;
        margin-bottom: 15px;
      }
      
      .tour-note {
        font-size: 16px;
        margin-top: 10px;
      }
    }
    
    .divider {
      width: 100%;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent);
      margin: 32px 0 48px;
    }
    
    @media (min-width: 992px) {
      .divider {
        margin: 40px 0 60px;
      }
    }
    
    .section-title {
      font-size: 32px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 40px;
    }
    
    @media (min-width: 992px) {
      .section-title {
        font-size: 42px;
        margin-bottom: 80px;
      }
    }
    
    .steps-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 0 auto 60px;
    }
    
    @media (min-width: 992px) {
      .steps-container {
        gap: 20px;
        max-width: 800px;
        margin-bottom: 100px;
      }
    }
    
    .step-card {
      display: flex;
      gap: 16px;
      background: rgba(30, 30, 45, 0.6);
      border-radius: 16px;
      padding: 20px;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    @media (min-width: 992px) {
      .step-card {
        gap: 30px;
        padding: 30px;
      }
    }
    
    .step-number {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
      margin-right: 8px;
      min-width: 24px;
    }
    
    .step-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(100, 100, 255, 0.2), rgba(50, 50, 120, 0.2));
      color: var(--text-primary);
      font-size: 20px;
      flex-shrink: 0;
    }
    
    @media (min-width: 992px) {
      .step-number {
        font-size: 32px;
        margin-right: 16px;
        min-width: 40px;
      }
      
      .step-icon {
        width: 70px;
        height: 70px;
        border-radius: 12px;
        font-size: 28px;
      }
    }
    
    .step-content {
      flex: 1;
    }
    
    .step-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-primary);
    }
    
    .step-description {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-secondary);
    }
    
    @media (min-width: 992px) {
      .step-title {
        font-size: 24px;
        margin-bottom: 8px;
      }
      
      .step-description {
        font-size: 16px;
        line-height: 1.5;
      }
    }
    
    .bottom-cta {
      text-align: center;
      margin-bottom: 60px;
    }
    
    .bottom-cta .tour-cta-button {
      max-width: 340px;
      margin: 0 auto;
    }
    
    @media (min-width: 992px) {
      .bottom-cta {
        margin-bottom: 80px;
      }
      
      .bottom-cta .tour-cta-button {
        max-width: 400px;
      }
    }
    
    /* Brand-styled CTA button */
    .branded-cta-button {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-blue));
      color: white;
      border: none;
      padding: 16px;
      width: 100%;
      text-align: center;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 24px;
      margin-bottom: 12px;
      box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    
    .branded-cta-button::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: translateX(-100%);
      transition: transform 1s ease;
    }
    
    .branded-cta-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(255, 107, 157, 0.4);
    }
    
    .branded-cta-button:hover::after {
      transform: translateX(100%);
    }
    
    @media (min-width: 992px) {
      .tour-cta-button, .branded-cta-button {
        padding: 18px 40px;
        font-size: 18px;
        margin-top: 30px;
        margin-bottom: 15px;
      }
      
      .branded-cta-button {
        font-size: 19px;
      }
      
      .tour-note {
        font-size: 16px;
        margin-top: 10px;
      }
    }

    /* Animation keyframes */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes glowPulse {
      0% {
        filter: drop-shadow(0 0 8px rgba(255, 107, 157, 0.7));
      }
      50% {
        filter: drop-shadow(0 0 15px rgba(255, 107, 157, 0.9));
      }
      100% {
        filter: drop-shadow(0 0 8px rgba(255, 107, 157, 0.7));
      }
    }
    
    @keyframes gradientFlow {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    
    /* Tour button styles */
    .tour-btn {
      margin-top: 16px;
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 14px 32px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .tour-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    /* Tour screen styles */
    .tour-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .tour-header {
      display: flex;
      align-items: center;
      padding: 12px 0;
      margin-bottom: 20px;
      animation: fadeInUp 0.6s ease forwards;
    }
    
    .tour-hero {
      display: flex;
      flex-direction: column;
      margin: 20px 0 60px;
      position: relative;
      align-items: center;
      text-align: center;
    }
    
    @media (min-width: 992px) {
      .tour-container {
        padding: 0 40px;
      }
      
      .tour-header {
        padding: 20px 0;
        margin-bottom: 40px;
      }
      
      .tour-hero {
        flex-direction: row;
        align-items: flex-start;
        text-align: left;
        margin: 60px 0 100px;
        gap: 60px;
      }
    }
    
    .tour-hero-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      max-width: 100%;
      margin-bottom: 40px;
      animation: fadeInRight 0.8s ease-out forwards;
    }
    
    .tour-hero-right {
      width: 100%;
      max-width: 360px;
      margin: 0 auto;
      animation: fadeInLeft 0.8s ease-out forwards;
    }
    
    @media (min-width: 992px) {
      .tour-hero-left {
        flex: 1;
        align-items: flex-start;
        text-align: left;
        margin-bottom: 0;
      }
      
      .tour-hero-right {
        flex: 1;
        max-width: 400px;
        margin: 0;
      }
    }
    
    .tour-neon-heart {
      width: 220px;
      height: 220px;
      margin-bottom: 32px;
      filter: drop-shadow(0 0 12px rgba(255, 107, 157, 0.8));
      animation: floatAnimation 6s ease-in-out infinite, glowPulse 4s ease-in-out infinite;
    }
    
    @media (min-width: 992px) {
      .tour-neon-heart {
        width: 280px;
        height: 280px;
        margin-bottom: 40px;
      }
    }
    
    @keyframes floatAnimation {
      0% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-15px);
      }
      100% {
        transform: translateY(0);
      }
    }
    
    .tour-title {
      font-size: 40px;
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: 20px;
      color: var(--text-primary);
      opacity: 0;
      animation: fadeInUp 0.8s ease forwards 0.2s;
    }
    
    .tour-subtitle {
      font-size: 20px;
      line-height: 1.4;
      color: var(--text-secondary);
      margin-bottom: 32px;
      max-width: 500px;
      opacity: 0;
      animation: fadeInUp 0.8s ease forwards 0.4s;
    }
    
    @media (min-width: 992px) {
      .tour-title {
        font-size: 56px;
        margin-bottom: 24px;
      }
      
      .tour-subtitle {
        font-size: 24px;
        margin-bottom: 48px;
      }
    }
    
    .message-card {
      background: rgba(30, 30, 45, 0.8);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-align: left;
    }
    
    .message-content {
      font-size: 19px;
      line-height: 1.5;
      color: var(--text-primary);
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .message-meta {
      font-size: 14px;
      color: var(--text-secondary);
      font-style: italic;
    }
    
    @media (min-width: 992px) {
      .message-card {
        padding: 30px;
      }
      
      .message-content {
        font-size: 21px;
      }
    }
    
    .tour-cta-button {
      display: inline-block;
      background: rgba(50, 50, 80, 0.9);
      color: white;
      border: none;
      padding: 16px;
      width: 100%;
      text-align: center;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 24px;
      margin-bottom: 12px;
      opacity: 0;
      animation: fadeInUp 0.8s ease forwards 0.2s;
    }
    
    .tour-cta-button:hover {
      background: rgba(60, 60, 100, 0.95);
      transform: translateY(-3px);
    }
    
    /* Brand-styled CTA button */
    .branded-cta-button {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-blue), var(--accent-pink));
      background-size: 200% 200%;
      color: white;
      border: none;
      padding: 16px;
      width: 100%;
      text-align: center;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 24px;
      margin-bottom: 12px;
      box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);
      position: relative;
      overflow: hidden;
      opacity: 0;
      animation: fadeInUp 0.8s ease forwards 0.4s, gradientFlow 8s ease infinite;
    }
    
    .branded-cta-button::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: translateX(-100%);
      transition: transform 1s ease;
    }
    
    .branded-cta-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(255, 107, 157, 0.4);
    }
    
    .branded-cta-button:hover::after {
      transform: translateX(100%);
    }
    
    .tour-note {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 8px;
      opacity: 0;
      animation: fadeInUp 0.8s ease forwards 0.6s;
    }
    
    @media (min-width: 992px) {
      .tour-cta-button, .branded-cta-button {
        padding: 18px 40px;
        font-size: 18px;
        margin-top: 30px;
        margin-bottom: 15px;
      }
      
      .branded-cta-button {
        font-size: 19px;
      }
      
      .tour-note {
        font-size: 16px;
        margin-top: 10px;
      }
    }
    
    .divider {
      width: 100%;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent);
      margin: 32px 0 48px;
      opacity: 0;
      animation: fadeInUp 0.8s ease forwards 0.2s;
    }
    
    @media (min-width: 992px) {
      .divider {
        margin: 40px 0 60px;
      }
    }
    
    .section-title {
      font-size: 32px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 40px;
      opacity: 0;
      animation: fadeInUp 0.8s ease forwards 0.3s;
    }
    
    @media (min-width: 992px) {
      .section-title {
        font-size: 42px;
        margin-bottom: 80px;
      }
    }
    
    .steps-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 0 auto 60px;
    }
    
    @media (min-width: 992px) {
      .steps-container {
        gap: 20px;
        max-width: 800px;
        margin-bottom: 100px;
      }
    }
    
    .step-card {
      display: flex;
      gap: 16px;
      background: rgba(30, 30, 45, 0.6);
      border-radius: 16px;
      padding: 20px;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.05);
      opacity: 0;
      transform: translateY(20px);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }
    
    .step-card:nth-child(1) {
      animation: fadeInUp 0.6s ease forwards 0.4s;
    }
    
    .step-card:nth-child(2) {
      animation: fadeInUp 0.6s ease forwards 0.6s;
    }
    
    .step-card:nth-child(3) {
      animation: fadeInUp 0.6s ease forwards 0.8s;
    }
    
    .step-card:nth-child(4) {
      animation: fadeInUp 0.6s ease forwards 1s;
    }
    
    .step-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      background: rgba(40, 40, 60, 0.7);
    }
    
    @media (min-width: 992px) {
      .step-card {
        gap: 30px;
        padding: 30px;
      }
    }
    
    .step-number {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
      margin-right: 8px;
      min-width: 24px;
    }
    
    .step-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(100, 100, 255, 0.2), rgba(50, 50, 120, 0.2));
      color: var(--text-primary);
      font-size: 20px;
      flex-shrink: 0;
      transition: transform 0.3s ease, background 0.3s ease;
    }
    
    .step-card:hover .step-icon {
      transform: scale(1.1) rotate(5deg);
      background: linear-gradient(135deg, rgba(255, 107, 157, 0.2), rgba(100, 140, 255, 0.2));
    }
    
    @media (min-width: 992px) {
      .step-number {
        font-size: 32px;
        margin-right: 16px;
        min-width: 40px;
      }
      
      .step-icon {
        width: 70px;
        height: 70px;
        border-radius: 12px;
        font-size: 28px;
      }
    }
    
    .step-content {
      flex: 1;
    }
    
    .step-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-primary);
    }
    
    .step-description {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-secondary);
    }
    
    @media (min-width: 992px) {
      .step-title {
        font-size: 24px;
        margin-bottom: 8px;
      }
      
      .step-description {
        font-size: 16px;
        line-height: 1.5;
      }
    }
    
    .bottom-cta {
      text-align: center;
      margin-bottom: 60px;
      opacity: 0;
      animation: fadeInUp 0.8s ease forwards 1.2s;
    }
    
    .bottom-cta .branded-cta-button {
      max-width: 340px;
      margin: 0 auto;
      animation: none;
      opacity: 1;
    }
    
    @media (min-width: 992px) {
      .bottom-cta {
        margin-bottom: 80px;
      }
      
      .bottom-cta .branded-cta-button {
        max-width: 400px;
      }
    }
    
    /* Additional mobile optimizations for tour screen */
    @media (max-width: 768px) {
      .tour-title {
        font-size: 34px;
        line-height: 1.2;
      }
      
      .tour-subtitle {
        font-size: 18px;
        line-height: 1.4;
        padding: 0 5px;
      }
      
      .step-description {
        font-size: 13px;
      }
    }
    
    @media (max-width: 480px) {
      .tour-title {
        font-size: 28px;
      }
      
      .tour-subtitle {
        font-size: 16px;
      }
      
      .step-title {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Welcome Screen -->
    <div id="welcome-screen" class="screen active">
      <div class="welcome-container">
        <div class="welcome-content">
          <div class="welcome-heart">
            <svg viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:var(--accent-pink)"/>
                  <stop offset="100%" style="stop-color:var(--accent-blue)"/>
                </linearGradient>
              </defs>
              <path d="M256 412.8L219.2 379.2C128 298.7 68.3 245.3 68.3 177.9C68.3 123.2 111.5 80 166.2 80C195.8 80 224.1 93.1 256 118.4C287.9 93.1 316.2 80 345.8 80C400.5 80 443.7 123.2 443.7 177.9C443.7 245.3 384 298.7 292.8 379.2L256 412.8Z"/>
            </svg>
          </div>
        <h1 class="welcome-title">Say what you feel, the way they'll hear it.</h1>
        <p class="welcome-subtitle">Hard to say. Easy to feel. Let AI help you bridge the gap.</p>
          <button id="login-register-btn">Start Your First Message - Free</button>
          <button id="take-tour-btn" class="tour-btn">See How It Works</button>
          <p class="trust-badge">Built on OpenAI. Designed for human connection.</p>
          
          <!-- Test button for Perplexity (hidden in production) -->
          <button id="test-perplexity-btn" class="test-btn" style="margin-top: 20px; background: #444; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; display: none;">Test Perplexity API</button>
        </div>
      </div>
    </div>
    
    <!-- Tour Screen -->
    <div id="tour-screen" class="screen">
      <div class="tour-container">
        <div class="tour-header">
          <button id="back-to-welcome-btn" class="back-button">
            <span class="back-icon">â†</span> Back
          </button>
        </div>
        
        <div class="tour-hero">
          <div class="tour-hero-left">
            <div class="tour-neon-heart">
              <svg viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M256 412.8L219.2 379.2C128 298.7 68.3 245.3 68.3 177.9C68.3 123.2 111.5 80 166.2 80C195.8 80 224.1 93.1 256 118.4C287.9 93.1 316.2 80 345.8 80C400.5 80 443.7 123.2 443.7 177.9C443.7 245.3 384 298.7 292.8 379.2L256 412.8Z" stroke="url(#neonHeartGradient)" stroke-width="12" stroke-linecap="round" stroke-linejoin="round"/>
                <defs>
                  <linearGradient id="neonHeartGradient" x1="0%" y1="0%" x2="100%" y2="100%" gradientUnits="userSpaceOnUse">
                    <stop offset="0%" stop-color="var(--accent-pink)"/>
                    <stop offset="100%" stop-color="var(--accent-blue)"/>
                  </linearGradient>
                </defs>
              </svg>
            </div>
            
            <h1 class="tour-title">Words matter. Make yours count.</h1>
            <p class="tour-subtitle">When emotions are complex, finding the right message shouldn't be.</p>
          </div>
          
          <div class="tour-hero-right">
            <div class="message-card">
              <div class="message-content">
                I've been thinking about you and wanted to reach out. How have you been holding up?
              </div>
              <div class="message-meta">
                Generated with Tone: Encouraging | Intensity: 3/5
              </div>
            </div>
            
            <button id="tour-signup-btn" class="branded-cta-button">Create Your Message - Free</button>
            <p class="tour-note">Start now â€” no account needed</p>
          </div>
        </div>
        
        <div class="divider"></div>
        
        <h2 class="section-title">How it works</h2>
        
        <div class="steps-container">
          <div class="step-card">
            <div class="step-number">1</div>
            <div class="step-icon">ðŸ‘¥</div>
            <div class="step-content">
              <h3 class="step-title">Choose your relationship</h3>
              <p class="step-description">Tell us who you're talking to - each connection needs its own language</p>
            </div>
          </div>
          
          <div class="step-card">
            <div class="step-number">2</div>
            <div class="step-icon">âœï¸</div>
            <div class="step-content">
              <h3 class="step-title">Share your feelings</h3>
              <p class="step-description">Describe what you want to express - no judgment, just understanding</p>
            </div>
          </div>
          
          <div class="step-card">
            <div class="step-number">3</div>
            <div class="step-icon">â­</div>
            <div class="step-content">
              <h3 class="step-title">Set the perfect tone</h3>
              <p class="step-description">Gentle, direct, playful, or somewhere in between - you decide</p>
            </div>
          </div>
          
          <div class="step-card">
            <div class="step-number">4</div>
            <div class="step-icon">ðŸ’¬</div>
            <div class="step-content">
              <h3 class="step-title">Get your message</h3>
              <p class="step-description">Choose from thoughtful options that sound authentically like you</p>
            </div>
          </div>
        </div>
        
        <div class="bottom-cta">
          <button id="tour-signup-btn-bottom" class="branded-cta-button">Create Your Message - Free</button>
        </div>
      </div>
    </div>
    
    <!-- Auth Screen -->
    <div id="auth-screen" class="screen">
      <div class="auth-container">
        <div class="auth-logo"></div>
        <h1 class="auth-title">Log in or sign up</h1>
        
        <!-- Add Google Sign In button -->
        <button id="google-sign-in" class="google-btn">
          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMTcuNiA5LjJsLS4xLTEuOEg5djMuNGg0LjhDMTMuNiAxMiAxMyAxMyAxMiAxMy42djIuMmgzYTguOCA4LjggMCAwIDAgMi42LTYuNnoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjxwYXRoIGQ9Ik05IDE4YzIuNCAwIDQuNS0uOCA2LTIuMmwtMy0yLjJhNS40IDUuNCAwIDAgMS04LTIuOUgxVjEzYTkgOSAwIDAgMCA4IDV6IiBmaWxsPSIjMzRBODUzIiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNNCAxMC43YTUuNCA1LjQgMCAwIDEgMC0zLjRWNUgxYTkgOSAwIDAgMCAwIDhsMy0yLjN6IiBmaWxsPSIjRkJCQzA1IiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNOSAzLjZjMS4zIDAgMi41LjQgMy40IDEuM0wxNSAyLjNBOSA5IDAgMCAwIDEgNWwzIDIuNGE1LjQgNS40IDAgMCAxIDUtMy43eiIgZmlsbD0iI0VBNDMzNSIgZmlsbC1ydWxlPSJub256ZXJvIi8+PHBhdGggZD0iTTAgMGgxOHYxOEgweiIvPjwvZz48L3N2Zz4=" alt="Google logo">
          Continue with Google
        </button>
        
        <div class="auth-divider">
          <span>or continue with email</span>
        </div>
        
        <form id="auth-form" class="auth-form">
          <label class="input-label" for="email">Email</label>
          <input type="email" id="email" class="input-field" placeholder="Enter your email">
          
          <label class="input-label" for="password">Password</label>
          <input type="password" id="password" class="input-field" placeholder="Enter your password">
          
          <button type="submit" id="auth-submit-btn" class="btn">Continue</button>
        </form>
        <div class="auth-links">
          <span id="auth-toggle-text">Don't have an account?</span>
          <a href="#" id="auth-toggle-link" class="auth-link">Sign up</a>
        </div>
        <div class="auth-links">
          <a href="#" id="forgot-password-link" class="auth-link">Forgot password?</a>
        </div>
      </div>
    </div>
    
    <!-- Home Screen -->
    <div id="home-screen" class="screen">
      <div class="header">
        <div class="logo-container">
          <div class="logo-heart"></div>
          <span class="logo-text">HeartGlowAI</span>
        </div>
      </div>
      
      <div class="home-header">
        <h1 class="home-title">Start a meaningful conversation</h1>
        <p class="home-subtitle">Choose a template or start fresh â€” we'll guide you.</p>
      </div>
      
      <div class="home-actions">
        <button id="dashboard-btn" class="settings-btn">
          <span class="settings-icon">ðŸ“Š</span> Dashboard
        </button>
        
        <button id="history-btn" class="settings-btn">
          <span class="settings-icon">ðŸ“‹</span> History
        </button>
        
        <button id="logout-btn" class="settings-btn">
          <span class="settings-icon">ðŸ‘¤</span> Logout
        </button>
      </div>
      
      <button id="new-conversation-btn" class="new-conversation-btn">
        <span class="new-conversation-icon">ðŸ’¬</span> Start a New Conversation
      </button>
      
      <!-- Learn button for Perplexity API Test -->
      <button id="learn-btn" class="new-conversation-btn" style="background-color: #6c4ba3; margin-top: 10px; font-size: 14px; padding: 10px 15px;">
        <span class="new-conversation-icon">ðŸ§ </span> Learn
      </button>
      
      <!-- Templates Section -->
      <div id="templates-section" class="templates-section">
        <h2 class="section-title">Message Templates</h2>
        
        <!-- Everyday Check-ins Category -->
        <div class="template-category">
          <h3 class="category-title">Everyday Check-Ins</h3>
          <div class="templates-grid">
            <div class="template-card" data-template="checkin">
              <div class="template-icon">ðŸ‘‹</div>
              <div class="template-name">Check-In</div>
              <div class="template-description">Reconnect with someone you haven't spoken to in a while</div>
            </div>
            <div class="template-card" data-template="encouragement">
              <div class="template-icon">â­</div>
              <div class="template-name">Encouragement</div>
              <div class="template-description">Offer support during a challenging time</div>
            </div>
          </div>
        </div>
        
        <!-- Repair & Reconnect Category -->
        <div class="template-category">
          <h3 class="category-title">Repair & Reconnect</h3>
      <div class="templates-grid">
        <div class="template-card" data-template="apology">
              <div class="template-icon">âœ‰ï¸</div>
          <div class="template-name">Apology</div>
              <div class="template-description">Make amends with empathy and sincerity</div>
        </div>
            <div class="template-card" data-template="tough">
              <div class="template-icon">ðŸ’¬</div>
              <div class="template-name">Tough Talk</div>
              <div class="template-description">Navigate a difficult conversation with respect</div>
            </div>
          </div>
        </div>
        
        <!-- Celebrate & Appreciate Category -->
        <div class="template-category">
          <h3 class="category-title">Celebrate & Appreciate</h3>
          <div class="templates-grid">
        <div class="template-card" data-template="romantic">
              <div class="template-icon">â¤ï¸</div>
          <div class="template-name">Romantic</div>
              <div class="template-description">Express your love and affection</div>
        </div>
            <div class="template-card" data-template="gratitude">
              <div class="template-icon">ðŸ™</div>
              <div class="template-name">Gratitude</div>
              <div class="template-description">Show appreciation for their support</div>
        </div>
            <div class="template-card" data-template="celebration">
              <div class="template-icon">ðŸŽ‰</div>
              <div class="template-name">Celebration</div>
              <div class="template-description">Congratulate someone on their achievement</div>
        </div>
            <div class="template-card" data-template="sympathy">
              <div class="template-icon">ðŸ’</div>
              <div class="template-name">Sympathy</div>
              <div class="template-description">Offer comfort during a difficult time</div>
            </div>
          </div>
        </div>
        
        <button id="feedbackButton" class="feedback-button">
          <span class="feedback-icon">â­</span> Submit Feedback
        </button>
      </div>
    </div>
    
    <!-- Message Generator Screen -->
    <div id="generator-screen" class="screen">
      <button id="back-to-home-btn" class="back-button">
        <span class="back-icon">â†</span> Back
      </button>
      
      <div class="generator-container">
        <div class="form-container">
          <div class="input-group">
            <label for="scenario">What would you like to say?</label>
            <textarea id="scenario" placeholder="Example: I want to express my gratitude for their support during a difficult time"></textarea>
          </div>
          
          <div class="input-group">
            <label for="relationship">Relationship Type</label>
            <select id="relationship">
              <option value="Friend">Friend</option>
              <option value="Romantic Partner">Romantic Partner</option>
              <option value="Family Member">Family Member</option>
              <option value="Professional">Professional</option>
              <option value="Mentor">Mentor</option>
            </select>
          </div>
          
          <div class="input-group">
            <label for="tone">Message Tone</label>
            <select id="tone">
              <option value="casual">Casual</option>
              <option value="formal">Formal</option>
              <option value="humorous">Humorous</option>
              <option value="serious">Serious</option>
              <option value="poetic">Poetic</option>
              <option value="professional">Professional</option>
            </select>
          </div>
          
          <div class="input-group">
            <label for="intensity">Tone Intensity</label>
            <div class="slider-container">
              <input type="range" id="intensity" min="1" max="5" value="3" class="slider">
              <div class="slider-labels">
                <span>Subtle</span>
                <span>Balanced</span>
                <span>Strong</span>
              </div>
            </div>
          </div>
          
          <div class="input-group">
            <label for="duration">Relationship Duration</label>
            <select id="duration">
              <option value="unspecified">Not specified</option>
              <option value="new">New/Recent</option>
              <option value="few months">Few months</option>
              <option value="1-5 years">1-5 years</option>
              <option value="5+ years">5+ years</option>
              <option value="lifelong">Lifelong</option>
            </select>
          </div>
          
          <div class="input-group">
            <label for="circumstances">Special Circumstances (Optional)</label>
            <textarea id="circumstances" placeholder="Example: We recently had an argument, or They're going through a tough time"></textarea>
          </div>
          
          <button id="generateBtn" class="primary-button">
            <span class="button-content">
              Generate Message
              <span class="button-icon">âœ¨</span>
            </span>
          </button>
        </div>
        
        <div id="result" class="result-card" style="display: none;">
          <div class="message-text" id="messageText"></div>
          <div class="button-group">
            <button class="copy-button" onclick="copyMessage()">Copy Message</button>
            <button class="tweak-button" onclick="showFeedback()">Tweak Message</button>
          </div>
          <div class="feedback-section" id="feedbackSection">
            <label for="feedback">How would you like to improve this message?</label>
            <textarea id="feedback" class="feedback-input" placeholder="Example: Make it more formal, add more emotion, be more specific about..."></textarea>
            <button class="tweak-button" onclick="tweakMessage()">Generate New Version</button>
          </div>
          <div class="insights-section">
            <div class="insights-title">Why this message works:</div>
            <ul class="insights-list" id="insightsList"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-container">
      <div class="heart-animation">
        <div class="heart-shape"></div>
        <div class="heart-glow"></div>
        <div class="heart-particles">
          <div class="particle"></div>
          <div class="particle"></div>
          <div class="particle"></div>
          <div class="particle"></div>
          <div class="particle"></div>
        </div>
      </div>
      <div id="loadingContext" class="loading-context">Creating your message...</div>
    </div>
  </div>
  
  <!-- Add Results Popup Overlay -->
  <div id="resultsPopupOverlay" class="results-popup-overlay">
    <div class="results-popup-container">
      <div class="results-popup-header">
        <h2 class="results-popup-title">Your Message</h2>
        <button class="results-popup-close" onclick="hideResultsPopup()">Ã—</button>
      </div>
      
      <div class="results-popup-message" id="popupMessageText"></div>
      
      <div class="results-popup-actions">
        <button class="results-popup-copy-btn" onclick="copyPopupMessage()">
          <span>ðŸ“‹</span> Copy Message
        </button>
        <button class="results-popup-tweak-btn" onclick="showPopupFeedback()">
          <span>âœï¸</span> Tweak Message
        </button>
      </div>
      
      <div class="results-popup-feedback" id="popupFeedbackSection">
        <textarea id="popupFeedback" placeholder="How would you like to improve this message? Be specific about what to change."></textarea>
        <button class="results-popup-tweak-btn" onclick="tweakPopupMessage()">Generate New Version</button>
      </div>
      
      <div class="results-popup-insights">
        <div class="results-popup-insights-title">Why this message works:</div>
        <ul class="results-popup-insights-list" id="popupInsightsList"></ul>
      </div>
    </div>
  </div>
  
  <!-- Add Dashboard Screen -->
  <div id="dashboard-screen" class="screen">
    <div class="dashboard-container">
      <div class="dashboard-header">
        <div class="logo-container">
          <div class="logo-heart"></div>
          <span class="logo-text">HeartGlowAI</span>
        </div>
      </div>
      
      <h1 class="dashboard-title">Dashboard</h1>
      <p class="dashboard-subtitle">Track your communication progress and insights</p>
      
      <div class="dashboard-card">
        <div class="dashboard-card-title">
          <span class="icon">ðŸ“ˆ</span> Message Statistics
        </div>
        <div class="stats-container">
          <div class="stat-item">
            <div class="stat-value" data-stat="messages">...</div>
            <div class="stat-label">Messages Created</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" data-stat="relationships">...</div>
            <div class="stat-label">Relationships</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" data-stat="templates">...</div>
            <div class="stat-label">Templates Used</div>
          </div>
        </div>
        <div class="chart-container">
          <div class="chart-placeholder">Message activity chart will appear here</div>
        </div>
      </div>
      
      <div class="dashboard-card">
        <div class="dashboard-card-title">
          <span class="icon">ðŸ’¬</span> Recent Messages
        </div>
        <div class="message-history">
          <div style="text-align: center; padding: 20px;">Loading messages...</div>
        </div>
      </div>
      
      <div class="dashboard-actions">
        <button id="back-to-home-from-dashboard" class="dashboard-btn">
          <span class="dashboard-icon">â†</span> Back to Home
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // Global variables and functions
    let currentMessage = '';
    let currentUser = null;
    let welcomeScreen, authScreen, homeScreen, generatorScreen, tourScreen; // Declare screen variables globally
    let messageCount = 0;
    let hasSubmittedFeedback = false;
    
    // Popup functions defined at the top of the script
    let resultPopupOverlay = null;
    let popupMessageText = null;
    let popupInsightsList = null;
    let copyMessageBtn = null;
    let closeFeedbackBtn = null;
    let resultCard = null;

    function initializePopupElements() {
      resultPopupOverlay = document.getElementById('resultsPopupOverlay');
      popupMessageText = document.getElementById('popupMessageText');
      popupInsightsList = document.getElementById('popupInsightsList');
      resultCard = document.getElementById('result');
    }

    // Screen transition function
    function showScreen(screen) {
      const screens = [welcomeScreen, authScreen, homeScreen, generatorScreen, tourScreen];
      screens.forEach(s => {
        if (s === screen) {
          s.style.display = 'flex';
          setTimeout(() => s.classList.add('active'), 50);
        } else {
          s.classList.remove('active');
          setTimeout(() => {
            if (!s.classList.contains('active')) {
              s.style.display = 'none';
            }
          }, 500);
        }
      });
    }

    // Initialize app function
    function initializeApp() {
      // Initialize screen elements
      welcomeScreen = document.getElementById('welcome-screen');
      authScreen = document.getElementById('auth-screen');
      homeScreen = document.getElementById('home-screen');
      generatorScreen = document.getElementById('generator-screen');
      tourScreen = document.getElementById('tour-screen');

      // Add favicon
      const favicon = document.createElement('link');
      favicon.rel = 'icon';
      favicon.type = 'image/svg+xml';
      favicon.href = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z' fill='%23ff6b9d'/%3E%3C/svg%3E";
      document.head.appendChild(favicon);

      // Show welcome screen by default
      showScreen(welcomeScreen);
    }

    // Save message to history function
    async function saveMessage(scenario, relationshipType, message) {
      if (!currentUser) return false;
      
      try {
        const timestamp = new Date();
        
        await firebase.firestore()
          .collection('users')
          .doc(currentUser.uid)
          .collection('messages')
          .add({
            scenario,
            relationshipType,
            message,
            timestamp
          });
        
        console.log('Message saved to history');
        return true;
      } catch (error) {
        console.error('Error saving message:', error);
        return false;
      }
    }

    // Global functions for feedback and copy functionality
    window.showFeedback = function() {
      const feedbackSection = document.getElementById('feedbackSection');
      feedbackSection.style.display = 'block';
      document.getElementById('feedback').focus();
    };

    window.tweakMessage = async function() {
      console.log("tweakMessage called");
      
      const feedback = document.getElementById('feedback');
      if (!feedback || !feedback.value.trim()) {
        showAlert("Please provide feedback for the message", 'error');
        return;
      }
      
      const feedbackText = feedback.value.trim();

      if (!currentUser) {
        showAlert("Please sign in to generate messages", 'error');
        return;
      }

      const scenario = document.getElementById('scenario')?.value.trim() || '';
      const relationship = document.getElementById('relationship')?.value || '';
      const tone = document.getElementById('tone')?.value || '';
      const intensity = document.getElementById('intensity')?.value || '';
      const duration = document.getElementById('duration')?.value || '';
      const circumstances = document.getElementById('circumstances')?.value.trim() || '';
      
      // Safely access loading and result elements
      const loadingSpinner = document.getElementById('loading');
      const resultCard = document.getElementById('result');
      
      // Show loading state
      if (loadingSpinner) {
      loadingSpinner.style.display = "flex";
      } else {
        console.warn("Loading spinner element not found");
      }
      
      // Hide result card
      if (resultCard) {
      resultCard.style.display = "none";
      } else {
        console.warn("Result card element not found");
      }
      
      // Also hide the popup if it's visible
      hideResultsPopup();
      
      try {
        // Get the current user's ID token
        const idToken = await currentUser.getIdToken();
        
        console.log("Sending tweak request:", {
          scenario,
          relationship,
          tone,
          intensity,
          duration,
          circumstances,
          previousMessage: currentMessage,
          feedbackText
        });

        const response = await fetch('https://us-central1-heartglowai.cloudfunctions.net/generateMessage', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': `Bearer ${idToken}`
          },
          body: JSON.stringify({
            scenario,
            relationshipType: relationship,
            tone,
            toneIntensity: intensity,
            relationshipDuration: duration,
            specialCircumstances: circumstances,
            previousMessage: currentMessage,
            userFeedback: feedbackText
          })
        });

        const data = await response.json();
        console.log("Tweak response:", data);
        
        if (response.ok) {
          // Update current message
          currentMessage = data.message;
          
          // Initialize popup elements if needed
          if (!popupMessageText) {
            initializePopupElements();
          }
          
          // Update popup content
          if (popupMessageText) {
            popupMessageText.textContent = data.message;
          }
          
          // Update popup insights
          if (popupInsightsList) {
            popupInsightsList.innerHTML = '';
            if (data.insights && data.insights.length > 0) {
              data.insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                popupInsightsList.appendChild(li);
              });
            }
          }
          
          // Update original card content (for compatibility)
          const messageText = document.getElementById('messageText');
          const insightsList = document.getElementById('insightsList');
          const feedbackSection = document.getElementById('feedbackSection');
          
          if (messageText) {
          messageText.textContent = data.message;
          }
          
          // Clear and populate insights in the original card
          if (insightsList) {
          insightsList.innerHTML = '';
          if (data.insights && data.insights.length > 0) {
            data.insights.forEach(insight => {
              const li = document.createElement('li');
              li.className = 'insight-item';
              li.textContent = insight;
              insightsList.appendChild(li);
            });
            }
          }
          
          // Reset feedback
          if (feedback) {
            feedback.value = '';
          }
          
          if (feedbackSection) {
          feedbackSection.style.display = 'none';
          }
          
          // Hide loading
          if (loadingSpinner) {
          loadingSpinner.style.display = "none";
          }
          
          // Show the results in the popup
          showResultsPopup();
          
          // Save message to history if user is authenticated
          if (currentUser) {
            await saveMessage(scenario, relationship, data.message);
          }
          
          // Safely update message count
          try {
            if (typeof updateMessageCount === 'function') {
              await updateMessageCount();
            } else {
              console.log('updateMessageCount function not available');
            }
          } catch (err) {
            console.log('Error updating message count:', err);
            // Non-critical error, continue
          }
        } else {
          throw new Error(data.error || 'Failed to generate message');
        }
      } catch (error) {
        console.error('Error generating tweaked message:', error);
        
        // Hide loading spinner
        if (loadingSpinner) {
        loadingSpinner.style.display = "none";
        }
        
        // Enhanced error handling
        if (error.message?.includes('authenticated')) {
          showAlert('Please sign in to generate messages', 'error');
        } else if (error.message?.includes('Failed to fetch') || error.message?.includes('Network error')) {
          showAlert('Network error - please check your connection', 'error');
        } else if (error.response?.status === 401) {
          showAlert('Authentication error - please sign in again', 'error');
        } else if (error.response?.status === 403) {
          showAlert('Permission denied - please contact support', 'error');
        } else {
          showAlert(error.message || 'Failed to generate message', 'error');
        }
      }
    };

    window.copyMessage = function() {
      const messageText = document.getElementById('messageText').textContent;
      navigator.clipboard.writeText(messageText).then(() => {
        showAlert('Message copied to clipboard!', 'success');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showAlert('Failed to copy message', 'error');
      });
    };

    // Global function for showing alerts
    function showAlert(message, type = 'error') {
      const alertEl = document.createElement('div');
      alertEl.style.position = 'fixed';
      alertEl.style.top = '20px';
      alertEl.style.left = '50%';
      alertEl.style.transform = 'translateX(-50%)';
      alertEl.style.padding = '12px 24px';
      alertEl.style.borderRadius = '8px';
      alertEl.style.color = 'white';
      alertEl.style.zIndex = '1000';
      alertEl.style.maxWidth = '90%';
      alertEl.style.textAlign = 'center';
      alertEl.style.animation = 'slideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
      alertEl.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
      alertEl.style.backdropFilter = 'blur(8px)';
      
      if (type === 'error') {
        alertEl.style.backgroundColor = 'rgba(255, 87, 87, 0.9)';
      } else if (type === 'success') {
        alertEl.style.backgroundColor = 'rgba(88, 214, 141, 0.9)';
      } else {
        alertEl.style.backgroundColor = 'rgba(52, 152, 219, 0.9)';
      }
      
      alertEl.textContent = message;
      document.body.appendChild(alertEl);
      
      setTimeout(() => {
        alertEl.style.transform = 'translateX(-50%) translateY(-20px)';
        alertEl.style.opacity = '0';
        alertEl.style.transition = 'all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        setTimeout(() => {
          document.body.removeChild(alertEl);
        }, 300);
      }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the app first
      initializeApp();

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBZiJPTs7dMccVgFV-YoTejnhy1bZNFEQY",
        authDomain: "heartglowai.firebaseapp.com",
        projectId: "heartglowai",
        storageBucket: "heartglowai.firebasestorage.app",
        messagingSenderId: "196565711798",
        appId: "1:196565711798:web:79e2b0320fd8e74ab0df17",
        measurementId: "G-KJMPL1DNPY"
      };
      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      
      // Initialize Firebase Analytics
      const analytics = firebase.analytics();
      
      // Track page view
      logAnalyticsEvent('page_view', {
        page_title: document.title,
        page_location: window.location.href
      });
      
      // Get elements
      const loginRegisterBtn = document.getElementById('login-register-btn');
      
      const authForm = document.getElementById('auth-form');
      const authSubmitBtn = document.getElementById('auth-submit-btn');
      const authToggleText = document.getElementById('auth-toggle-text');
      const authToggleLink = document.getElementById('auth-toggle-link');
      const forgotPasswordLink = document.getElementById('forgot-password-link');
      
      const newConversationBtn = document.getElementById('new-conversation-btn');
      const templateCards = document.querySelectorAll('.template-card');
      const settingsBtn = document.getElementById('history-btn');
      const logoutBtn = document.getElementById('logout-btn');
      
      const backToHomeBtn = document.getElementById('back-to-home-btn');
      const scenarioInput = document.getElementById('scenario');
      const relationshipSelect = document.getElementById('relationship');
      const generateBtn = document.getElementById('generateBtn');
      const loadingSpinner = document.getElementById('loading');
      const resultCard = document.getElementById('result');
      const resultMessage = document.getElementById('messageText');
      
      // Storage keys
      const STORAGE_KEYS = {
        USER_SETTINGS: 'user_settings',
        MESSAGE_HISTORY: 'message_history'
      };
      
      // Constants
      const RELATIONSHIP_TYPES = [
        "Romantic Partner",
        "Friend",
        "Family Member",
        "Professional Contact"
      ];
      
      // Auth state
      let isLogin = true;
      let openaiApiKey = null;
      
      // Check auth state
      firebase.auth().onAuthStateChanged(async (user) => {
        currentUser = user;
        
        if (user) {
          // Initialize user document if it doesn't exist
          const userRef = firebase.firestore().collection('users').doc(user.uid);
          const userDoc = await userRef.get();
          
          if (!userDoc.exists) {
            await userRef.set({
              email: user.email,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              messageCount: 0,
              hasFeedbackSubmitted: false,
              lastFeedbackSubmittedAt: null,
              feedbackData: null
            });
          }
          
          // Check feedback status
          await checkFeedbackStatus();
          
          showScreen(homeScreen);
          
          // Ensure template clicks work after auth state is determined
          attachTemplateClickListeners();
        } else {
          showScreen(welcomeScreen);
        }
      });
      
      // Function to attach template click listeners
      function attachTemplateClickListeners() {
        const templateCards = document.querySelectorAll('.template-card');
        console.log('Attaching template listeners to', templateCards.length, 'cards');
        
        templateCards.forEach(card => {
          const templateType = card.getAttribute('data-template');
          
          // Remove any existing listeners to prevent duplicates
          const newCard = card.cloneNode(true);
          card.parentNode.replaceChild(newCard, card);
          
          newCard.addEventListener('click', function() {
            console.log('Template clicked:', templateType);
            handleTemplateClick(templateType);
          });
        });
      }
      
      // Event Listeners
      loginRegisterBtn.addEventListener('click', function() {
        showScreen(authScreen);
      });
      
      // Tour navigation event listeners
      const takeTourBtn = document.getElementById('take-tour-btn');
      const backToWelcomeBtn = document.getElementById('back-to-welcome-btn');
      const tourSignupBtn = document.getElementById('tour-signup-btn');
      const tourSignupBtnBottom = document.getElementById('tour-signup-btn-bottom');
      
      takeTourBtn.addEventListener('click', function() {
        showScreen(tourScreen);
        
        // Log analytics event
        logAnalyticsEvent('tour_view', {
          source: 'welcome_screen'
        });
      });
      
      backToWelcomeBtn.addEventListener('click', function() {
        showScreen(welcomeScreen);
      });
      
      tourSignupBtn.addEventListener('click', function() {
        showScreen(authScreen);
        
        // Log analytics event
        logAnalyticsEvent('signup_click', {
          source: 'tour_page_top'
        });
      });
      
      tourSignupBtnBottom.addEventListener('click', function() {
        showScreen(authScreen);
        
        // Log analytics event
        logAnalyticsEvent('signup_click', {
          source: 'tour_page_bottom'
        });
      });
      
      authToggleLink.addEventListener('click', function(e) {
        e.preventDefault();
        isLogin = !isLogin;
        if (isLogin) {
          authToggleText.textContent = "Don't have an account?";
          authToggleLink.textContent = "Sign up";
          authSubmitBtn.textContent = "Continue";
        } else {
          authToggleText.textContent = "Already have an account?";
          authToggleLink.textContent = "Log in";
          authSubmitBtn.textContent = "Create Account";
        }
      });
      
      forgotPasswordLink.addEventListener('click', function(e) {
        e.preventDefault();
        const email = prompt("Please enter your email address to reset your password:");
        if (email) {
          firebase.auth().sendPasswordResetEmail(email)
            .then(() => {
              showAlert('Password reset email sent!', 'success');
            })
            .catch((error) => {
              showAlert(`Error: ${error.message}`, 'error');
            });
        }
      });
      
      authForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
          showAlert('Please enter both email and password', 'error');
          return;
        }
        
        if (isLogin) {
          // Login
          firebase.auth().signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
              showScreen(homeScreen);
            })
            .catch((error) => {
              showAlert(`Login error: ${error.message}`, 'error');
            });
        } else {
          // Register
          firebase.auth().createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
              // Create user document in Firestore
              firebase.firestore().collection('users').doc(userCredential.user.uid).set({
                email: email,
                createdAt: new Date()
              });
              
              showScreen(homeScreen);
              showAlert('Account created successfully!', 'success');
            })
            .catch((error) => {
              showAlert(`Registration error: ${error.message}`, 'error');
            });
        }
      });
      
      newConversationBtn.addEventListener('click', function() {
        scenarioInput.value = "";
        relationshipSelect.value = "Romantic Partner";
        resultCard.style.display = "none";
        showScreen(generatorScreen);
      });
      
      // Enhanced template presets
      const templates = {
        apology: {
          scenario: "I need to apologize to someone for missing an important event",
          relationship: "Friend",
          tone: "sincere",
          intensity: "4",
          duration: "few months",
          circumstances: "I missed their birthday celebration due to work commitments"
        },
        romantic: {
          scenario: "I want to express my love and appreciation to my partner",
          relationship: "Romantic Partner",
          tone: "poetic",
          intensity: "5",
          duration: "1-5 years",
          circumstances: "We recently celebrated our anniversary"
        },
        tough: {
          scenario: "I need to have a difficult conversation about boundaries",
          relationship: "Friend",
          tone: "formal",
          intensity: "3",
          duration: "few months",
          circumstances: "There have been some misunderstandings about personal space"
        },
        checkin: {
          scenario: "I want to check in with someone I haven't spoken to in a while",
          relationship: "Family Member",
          tone: "casual",
          intensity: "2",
          duration: "5+ years",
          circumstances: "We've been busy with our own lives but I miss them"
        },
        gratitude: {
          scenario: "I want to express deep gratitude for someone's support during a difficult time",
          relationship: "Friend",
          tone: "sincere",
          intensity: "4",
          duration: "1-5 years",
          circumstances: "They helped me through a challenging period in my life"
        },
        celebration: {
          scenario: "I want to congratulate someone on their recent achievement",
          relationship: "Professional",
          tone: "enthusiastic",
          intensity: "4",
          duration: "few months",
          circumstances: "They recently got promoted/completed a major project"
        },
        encouragement: {
          scenario: "I want to encourage someone who is facing a challenge",
          relationship: "Friend",
          tone: "supportive",
          intensity: "4",
          duration: "1-5 years",
          circumstances: "They're going through a difficult transition"
        },
        sympathy: {
          scenario: "I want to express sympathy and support during their loss",
          relationship: "Family Member",
          tone: "compassionate",
          intensity: "3",
          duration: "lifelong",
          circumstances: "They recently lost a loved one"
        }
      };

      // Enhanced feedback submission
      async function handleFeedbackSubmit() {
        const formData = {
          email: document.getElementById('feedbackEmail').value,
          userType: document.getElementById('feedbackUserType').value,
          messageQuality: document.querySelector('input[name="messageQuality"]:checked')?.value,
          easeOfUse: document.querySelector('input[name="easeOfUse"]:checked')?.value,
          features: Array.from(document.querySelectorAll('input[name="features"]:checked')).map(cb => cb.value),
          strengths: document.getElementById('feedbackStrengths').value.trim(),
          improvements: document.getElementById('feedbackImprovements').value.trim(),
          featureRequests: document.getElementById('feedbackFeatures').value.trim(),
          npsScore: document.getElementById('npsScore').value,
          timestamp: new Date().toISOString()
        };

        if (!formData.messageQuality || !formData.easeOfUse || !formData.strengths) {
          showAlert('Please fill in the star ratings and what you liked most', 'error');
          return;
        }

        try {
          const response = await fetch('https://formspree.io/f/xwplnpbl', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
          });

          if (response.ok) {
            if (currentUser) {
              // Update user document with feedback data but don't mark as submitted
              await firebase.firestore().collection('users').doc(currentUser.uid).update({
                lastFeedbackSubmittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                feedbackData: formData
              });
            }

            showAlert('Thank you for your detailed feedback!', 'success');
            hideFeedbackModal();
            
            // Reset form
            document.getElementById('feedbackForm').reset();
          } else {
            throw new Error('Failed to submit feedback');
          }
        } catch (error) {
          console.error('Feedback submission error:', error);
          showAlert('Failed to submit feedback. Please try again.', 'error');
        }
      }

      // Template card click handler
      function handleTemplateClick(templateType) {
              const template = templates[templateType];
        if (template) {
              document.getElementById('scenario').value = template.scenario;
              document.getElementById('relationship').value = template.relationship;
              document.getElementById('tone').value = template.tone;
              document.getElementById('intensity').value = template.intensity;
          document.getElementById('duration').value = template.duration;
          document.getElementById('circumstances').value = template.circumstances;
              document.getElementById('result').style.display = "none";
          showScreen(generatorScreen);
        }
      }

      // Add template click listeners
      document.addEventListener('DOMContentLoaded', function() {
        // Attach template click listeners on initial load
        attachTemplateClickListeners();
      });
      
      backToHomeBtn.addEventListener('click', function() {
        if (currentUser) {
          showScreen(homeScreen);
        } else {
          showScreen(welcomeScreen);
        }
      });
      
      settingsBtn.addEventListener('click', async function() {
        if (!currentUser) {
          showAlert('Please log in to view message history', 'error');
          return;
        }
        
        try {
          const messagesRef = firebase.firestore()
            .collection('users')
            .doc(currentUser.uid)
            .collection('messages')
            .orderBy('timestamp', 'desc')
            .limit(10);
            
          const snapshot = await messagesRef.get();
          
          if (snapshot.empty) {
            showAlert('No messages in history yet', 'info');
            return;
          }
          
          // Create and show history modal
          const modal = document.createElement('div');
          modal.style.position = 'fixed';
          modal.style.top = '50%';
          modal.style.left = '50%';
          modal.style.transform = 'translate(-50%, -50%)';
          modal.style.backgroundColor = 'var(--card-bg)';
          modal.style.padding = '20px';
          modal.style.borderRadius = '16px';
          modal.style.maxWidth = '90%';
          modal.style.width = '400px';
          modal.style.maxHeight = '80vh';
          modal.style.overflowY = 'auto';
          modal.style.zIndex = '1000';
          
          // Add close button
          const closeBtn = document.createElement('button');
          closeBtn.textContent = 'Ã—';
          closeBtn.style.position = 'absolute';
          closeBtn.style.right = '10px';
          closeBtn.style.top = '10px';
          closeBtn.style.background = 'none';
          closeBtn.style.border = 'none';
          closeBtn.style.color = 'white';
          closeBtn.style.fontSize = '24px';
          closeBtn.style.cursor = 'pointer';
          closeBtn.onclick = () => modal.remove();
          modal.appendChild(closeBtn);
          
          // Add title
          const title = document.createElement('h2');
          title.textContent = 'Message History';
          title.style.marginBottom = '20px';
          title.style.fontSize = '20px';
          title.style.fontWeight = '600';
          modal.appendChild(title);
          
          // Add messages
          snapshot.forEach(doc => {
            const data = doc.data();
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '20px';
            messageDiv.style.padding = '15px';
            messageDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            messageDiv.style.borderRadius = '8px';
            
            const header = document.createElement('div');
            header.style.marginBottom = '10px';
            header.style.fontSize = '14px';
            header.style.color = 'var(--text-secondary)';
            header.textContent = `${data.relationshipType} - ${new Date(data.timestamp.toDate()).toLocaleDateString()}`;
            messageDiv.appendChild(header);
            
            const scenario = document.createElement('div');
            scenario.style.marginBottom = '10px';
            scenario.style.fontSize = '14px';
            scenario.style.fontStyle = 'italic';
            scenario.textContent = data.scenario;
            messageDiv.appendChild(scenario);
            
            const message = document.createElement('div');
            message.style.fontSize = '15px';
            message.style.lineHeight = '1.5';
            message.textContent = data.message;
            messageDiv.appendChild(message);
            
            modal.appendChild(messageDiv);
          });
          
          // Add overlay
          const overlay = document.createElement('div');
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100%';
          overlay.style.height = '100%';
          overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
          overlay.style.zIndex = '999';
          overlay.onclick = () => {
            modal.remove();
            overlay.remove();
          };
          
          document.body.appendChild(overlay);
          document.body.appendChild(modal);
          
        } catch (error) {
          console.error('Error fetching message history:', error);
          showAlert('Error loading message history', 'error');
        }
      });
      
      logoutBtn.addEventListener('click', function() {
        if (confirm("Are you sure you want to log out?")) {
          firebase.auth().signOut()
            .then(() => {
              showScreen(welcomeScreen);
              showAlert('Logged out successfully', 'success');
            })
            .catch((error) => {
              showAlert(`Error logging out: ${error.message}`, 'error');
            });
        }
      });
      
      // Update the generateMessage function to store the current message
      generateBtn.addEventListener('click', async function() {
        // Show animation immediately
        showGenerateAnimation();
        
        // Track message generation attempt - use safe function
        logAnalyticsEvent('generate_message', {
          relationship_type: document.getElementById('relationship').value
        });
        
        const scenario = document.getElementById('scenario').value.trim();
        const relationship = document.getElementById('relationship').value;
        const tone = document.getElementById('tone').value;
        const intensity = document.getElementById('intensity').value;
        const duration = document.getElementById('duration').value;
        const circumstances = document.getElementById('circumstances').value.trim();
        
        if (!scenario) {
          showAlert("Please enter a communication scenario", 'error');
          return;
        }
        
        if (!currentUser) {
          showAlert("Please sign in to generate messages", 'error');
          return;
        }
        
        // Show the loading overlay with context about the message being generated
        updateLoadingContext(relationship, tone);
        showLoading();
        
        try {
          // Get the current user's ID token
          const idToken = await currentUser.getIdToken();
          
          console.log('Sending request to Cloud Function:', {
            scenario,
            relationshipType: relationship,
            tone,
            toneIntensity: intensity,
            relationshipDuration: duration,
            specialCircumstances: circumstances
          });
          
          const response = await fetch('https://us-central1-heartglowai.cloudfunctions.net/generateMessage', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'Authorization': `Bearer ${idToken}`
            },
            body: JSON.stringify({
              scenario,
              relationshipType: relationship,
              tone,
              toneIntensity: intensity,
              relationshipDuration: duration,
              specialCircumstances: circumstances
            })
          });
          
          console.log('Response status:', response.status);
          const data = await response.json();
          console.log('Response data:', data);
          
          if (!response.ok) {
            throw new Error(data.error || 'Failed to generate message');
          }
          
          if (!data.message) {
            throw new Error('No message received from server');
          }
          
          // Store current message for feedback
          currentMessage = data.message;
          
          // Display the message
          const messageText = document.getElementById('messageText');
          messageText.textContent = data.message;
          
          // Clear and populate insights
          const insightsList = document.getElementById('insightsList');
          insightsList.innerHTML = '';
          if (data.insights && data.insights.length > 0) {
            data.insights.forEach(insight => {
              const li = document.createElement('li');
              li.className = 'insight-item';
              li.textContent = insight;
              insightsList.appendChild(li);
            });
          }
          
          // Hide loading overlay and show result card
          hideLoading();
          
          // Initialize popup elements if needed
          if (!popupMessageText) {
            initializePopupElements();
          }
          
          // Update popup content
          if (popupMessageText) {
            popupMessageText.textContent = data.message;
          }
          
          // Update popup insights
          if (popupInsightsList) {
            popupInsightsList.innerHTML = '';
            if (data.insights && data.insights.length > 0) {
              data.insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                popupInsightsList.appendChild(li);
              });
            }
          }
          
          // Show popup instead of original card
          showResultsPopup();
          
          // Also update original card for compatibility (but keep it hidden)
          if (resultCard) {
            // Set content but keep hidden
            resultCard.style.display = "none";
          }
          
          // Save to history if logged in
          if (currentUser) {
            await saveMessage(scenario, relationship, data.message);
          }
          
          // After successful message generation, update message count
          try {
            if (typeof updateMessageCount === 'function') {
              await updateMessageCount();
            } else {
              console.log('updateMessageCount function not available');
            }
          } catch (err) {
            console.log('Error updating message count:', err);
            // Non-critical error, continue
          }
        } catch (error) {
          // Hide loading
          hideLoading();
          
          console.error('Error details:', {
            error: error,
            message: error.message,
            stack: error.stack,
            name: error.name
          });
          
          if (error.response) {
            console.error('Response error:', {
              status: error.response.status,
              data: error.response.data,
              headers: error.response.headers
            });
          }
          
          // Enhanced error handling
          if (error.message.includes('authenticated')) {
            showAlert('Please sign in to generate messages', 'error');
          } else if (error.message.includes('Failed to fetch') || error.message.includes('Network error')) {
            showAlert('Network error - please check your connection', 'error');
          } else if (error.response?.status === 401) {
            showAlert('Authentication error - please sign in again', 'error');
          } else if (error.response?.status === 403) {
            showAlert('Permission denied - please contact support', 'error');
          } else {
          showAlert(error.message || 'Failed to generate message', 'error');
          }
        }
      });

      // Add Google Sign In functionality
      document.getElementById('google-sign-in').addEventListener('click', function() {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({
          prompt: 'select_account'
        });
        
        firebase.auth()
          .signInWithPopup(provider)
          .then((result) => {
            // Check if it's a new user
            const isNewUser = result.additionalUserInfo.isNewUser;
            
            if (isNewUser) {
              // Create user document in Firestore
              return firebase.firestore().collection('users').doc(result.user.uid).set({
                email: result.user.email,
                displayName: result.user.displayName,
                photoURL: result.user.photoURL,
                createdAt: new Date(),
                authProvider: 'google'
              }).then(() => {
                showAlert('Account created successfully!', 'success');
                showScreen(homeScreen);
              });
            } else {
              showScreen(homeScreen);
            }
          })
          .catch((error) => {
            console.error('Google Sign In Error:', error);
            showAlert(`Error: ${error.message}`, 'error');
          });
      });

      // Check for and redirect to feedback.html after a certain number of messages
      async function checkFeedbackStatus() {
        if (currentUser) {
          try {
            const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
            // Only check for first-time feedback submission
            hasSubmittedFeedback = userDoc.exists && userDoc.data().hasFeedbackSubmitted === true;
            
            if (!hasSubmittedFeedback) {
              // Get stored message count
              messageCount = userDoc.data()?.messageCount || 0;
            }
          } catch (error) {
            console.error('Error checking feedback status:', error);
          }
        }
      }

      // Update the message count in Firestore
      async function updateMessageCount() {
        if (currentUser && !hasSubmittedFeedback) {
          try {
            messageCount++;
            await firebase.firestore().collection('users').doc(currentUser.uid).update({
              messageCount: messageCount
            });

            if (messageCount >= 3) {
              // Instead of showing the modal, suggest visiting the feedback page
              showAlert('We value your feedback! Please click the "Submit Feedback" button when you have a moment.', 'info');
            }
          } catch (error) {
            console.error('Error updating message count:', error);
          }
        }
      }

      // Event Listeners for Feedback
      document.getElementById('feedbackButton').addEventListener('click', function() {
        window.location.href = 'feedback.html';
      });
      document.getElementById('feedbackCancel').addEventListener('click', hideFeedbackModal);
      document.getElementById('feedbackSubmit').addEventListener('click', handleFeedbackSubmit);
      document.getElementById('feedbackOverlay').addEventListener('click', hideFeedbackModal);

      // Update the generateMessage event listener to include feedback tracking
      generateBtn.addEventListener('click', async function() {
        // ... existing generate message code ...
        
        try {
          // ... existing try block code ...
          
          // After successful message generation, update message count
          try {
            if (typeof updateMessageCount === 'function') {
              await updateMessageCount();
            } else {
              console.log('updateMessageCount function not available');
            }
          } catch (err) {
            console.log('Error updating message count:', err);
            // Non-critical error, continue
          }
          
          // ... rest of the existing code ...
        } catch (error) {
          // ... existing error handling ...
        }
      });
    });

    function showGenerateAnimation() {
      const generateBtn = document.getElementById('generateBtn');
      
      // Add a 'generating' class with animation
      generateBtn.classList.add('generating');
      
      // Create and add the animation span
      const animationSpan = document.createElement('span');
      animationSpan.className = 'generate-animation';
      generateBtn.appendChild(animationSpan);
      
      // Remove after animation completes
      setTimeout(() => {
        generateBtn.classList.remove('generating');
        if (animationSpan && animationSpan.parentNode === generateBtn) {
          generateBtn.removeChild(animationSpan);
        }
      }, 1500);
    }

    // Update the loading context with user variables
    function updateLoadingContext(relationship, tone) {
      const loadingContext = document.getElementById('loadingContext');
      if (!loadingContext) return;
      
      // Craft a loading message based on the relationship and tone
      let message = `Creating a <span class="loading-highlight">${tone}</span> message for your <span class="loading-highlight">${relationship.toLowerCase()}</span>`;
      
      // Add variety based on tone
      switch(tone.toLowerCase()) {
        case 'casual':
          message += "... keeping it relaxed and friendly";
          break;
        case 'formal':
          message += "... with the right level of respect";
          break;
        case 'humorous':
          message += "... with a touch of humor";
          break;
        case 'poetic':
          message += "... with flowing, heartfelt words";
          break;
        case 'serious':
          message += "... with sincerity and depth";
          break;
        default:
          message += "... with the perfect words";
      }
      
      loadingContext.innerHTML = message;
    }
    
    // Show the loading overlay
    function showLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.add('active');
      }
    }
    
    // Hide the loading overlay
    function hideLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.remove('active');
      }
    }

    // Consolidated and improved showResultsPopup function
    function showResultsPopup() {
      console.log("showResultsPopup called");
      
      // Initialize elements if needed
      if (!resultPopupOverlay || !popupMessageText) {
        console.log("Re-initializing popup elements");
        initializePopupElements();
      }
      
      // Get the popup overlay element
      const popup = document.getElementById('resultsPopupOverlay');
      if (!popup) {
        console.error('Results popup overlay element not found');
        return false;
      }
      
      // Set high z-index to ensure it's above everything
      popup.style.zIndex = '10000';
      popup.style.display = 'flex';
      
      // Force browser to reflow the element for animation to work properly
      void popup.offsetWidth;
      
      // Add active class to trigger animations
      setTimeout(() => {
        popup.classList.add('active');
      }, 10);
      
      // Hide the original result card
      const resultCard = document.getElementById('result');
      if (resultCard) {
        resultCard.style.display = 'none';
      }
      
      return true;
    }

    // Improved hideResultsPopup function
    function hideResultsPopup() {
      console.log("hideResultsPopup called");
      
      // Initialize elements if needed
      if (!resultPopupOverlay) {
        console.log("Re-initializing popup elements");
        initializePopupElements();
      }
      
      const popup = document.getElementById('resultsPopupOverlay');
      if (!popup) {
        console.error('Results popup overlay element not found');
        return false;
      }
      
      popup.classList.remove('active');
      
      // Hide after transition completes
      setTimeout(() => {
        popup.style.display = 'none';
      }, 300);
      
      return true;
    }

    function showPopupFeedback() {
      console.log("showPopupFeedback called");
      
      // Make sure we have the popup elements
      if (!resultPopupOverlay) {
        initializePopupElements();
      }
      
      const feedbackSection = document.getElementById('popupFeedbackSection');
      if (!feedbackSection) {
        console.error('Popup feedback section element not found');
        return false;
      }
      
      feedbackSection.style.display = 'block';
      
      const popupFeedback = document.getElementById('popupFeedback');
      if (popupFeedback) {
        popupFeedback.focus();
      } else {
        console.warn('Popup feedback textarea not found');
      }
      
      return true;
    }

    function copyPopupMessage() {
      if (!popupMessageText) {
        initializePopupElements();
      }
      
      const textToCopy = popupMessageText.textContent;
      if (textToCopy) {
        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            alert('Message copied to clipboard!');
          })
          .catch(err => {
            console.error('Error copying text: ', err);
          });
      }
    }

    function tweakPopupMessage() {
      console.log("tweakPopupMessage called");
      
      // Get feedback from popup
      const popupFeedback = document.getElementById('popupFeedback');
      if (!popupFeedback || !popupFeedback.value.trim()) {
        showAlert("Please provide feedback for the message", 'error');
        return;
      }
      
      const feedbackText = popupFeedback.value.trim();
      
      if (!currentUser) {
        showAlert("Please sign in to generate messages", 'error');
        return;
      }
      
      // Get input values from the form
      const scenario = document.getElementById('scenario')?.value.trim() || '';
      const relationship = document.getElementById('relationship')?.value || '';
      const tone = document.getElementById('tone')?.value || '';
      const intensity = document.getElementById('intensity')?.value || '';
      const duration = document.getElementById('duration')?.value || '';
      const circumstances = document.getElementById('circumstances')?.value.trim() || '';
      
      // Show the loading overlay
      showLoading();
      
      // Hide the popup
      hideResultsPopup();
      
      // Make the API call directly instead of calling the original tweakMessage
      (async function() {
        try {
          // Get the current user's ID token
          const idToken = await currentUser.getIdToken();
          
          console.log('Sending tweak request from popup:', {
            scenario,
            relationshipType: relationship,
            tone,
            toneIntensity: intensity,
            relationshipDuration: duration,
            specialCircumstances: circumstances,
            previousMessage: currentMessage,
            userFeedback: feedbackText
          });
          
          const response = await fetch('https://us-central1-heartglowai.cloudfunctions.net/generateMessage', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'Authorization': `Bearer ${idToken}`
            },
            body: JSON.stringify({
              scenario,
              relationshipType: relationship,
              tone,
              toneIntensity: intensity,
              relationshipDuration: duration,
              specialCircumstances: circumstances,
              previousMessage: currentMessage,
              userFeedback: feedbackText
            })
          });
          
          console.log('Response status:', response.status);
          const data = await response.json();
          console.log('Response data:', data);
          
          if (response.ok) {
            // Update current message
            currentMessage = data.message;
            
            // Initialize popup elements if needed
            if (!popupMessageText) {
              initializePopupElements();
            }
            
            // Update popup content
            if (popupMessageText) {
              popupMessageText.textContent = data.message;
            }
            
            // Update popup insights
            if (popupInsightsList) {
              popupInsightsList.innerHTML = '';
              if (data.insights && data.insights.length > 0) {
                data.insights.forEach(insight => {
                  const li = document.createElement('li');
                  li.textContent = insight;
                  popupInsightsList.appendChild(li);
                });
              }
            }
            
            // For compatibility, also update the original card
            const messageText = document.getElementById('messageText');
            if (messageText) {
              messageText.textContent = data.message;
            }
            
            const insightsList = document.getElementById('insightsList');
            if (insightsList) {
              insightsList.innerHTML = '';
              if (data.insights && data.insights.length > 0) {
                data.insights.forEach(insight => {
                  const li = document.createElement('li');
                  li.className = 'insight-item';
                  li.textContent = insight;
                  insightsList.appendChild(li);
                });
              }
            }
            
            // Clear feedback input
            if (popupFeedback) {
              popupFeedback.value = '';
            }
            
            // Hide loading overlay
            hideLoading();
            
            // Show the popup with the new content
            showResultsPopup();
            
            // Save message to history if logged in
            if (currentUser) {
              await saveMessage(scenario, relationship, data.message);
            }
            
            // Safely call updateMessageCount
            try {
              if (typeof updateMessageCount === 'function') {
                await updateMessageCount();
              } else {
                console.log('updateMessageCount function not available');
              }
            } catch (err) {
              console.log('Error updating message count:', err);
              // Non-critical error, continue
            }
          } else {
            throw new Error(data.error || 'Failed to generate message');
          }
        } catch (error) {
          // Hide loading
          hideLoading();
          
          console.error('Error generating tweaked message:', error);
          
          // Enhanced error handling
          if (error.message?.includes('authenticated')) {
            showAlert('Please sign in to generate messages', 'error');
          } else if (error.message?.includes('Failed to fetch') || error.message?.includes('Network error')) {
            showAlert('Network error - please check your connection', 'error');
          } else {
            showAlert(error.message || 'Failed to generate message', 'error');
          }
        }
      })();
    }

    // Call this once DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      initializePopupElements();
    });

    // Fix analytics reference error
    function logAnalyticsEvent(eventName, eventParams) {
      // Try to use gtag if available
      if (typeof gtag === 'function') {
        gtag('event', eventName, eventParams);
      } else if (typeof analytics !== 'undefined' && analytics !== null) {
        // Fall back to analytics object if available
        analytics.logEvent(eventName, eventParams);
      } else {
        // If no analytics available, just log to console
        console.log('Analytics event:', eventName, eventParams);
      }
    }

    // Update the generateMessage function to properly handle analytics
    function generateMessage() {
      // Check if user is logged in
      const currentUser = gapi.auth2.getAuthInstance().currentUser.get();
      const isLoggedIn = currentUser.isSignedIn();
      
      // Get input values
      const scenario = document.getElementById('scenario').value;
      const relationship = document.getElementById('relationship').value;
      const tone = document.getElementById('tone').value;
      const intensity = document.getElementById('intensity').value;
      const duration = document.getElementById('duration').value;
      const circumstances = document.getElementById('circumstances').value;
      
      // Validate input
      if (!scenario || !relationship || !tone || !intensity || !duration) {
        alert('Please fill out all required fields.');
        return;
      }
      
      // Log analytics event using our safe function
      logAnalyticsEvent('generate_message', {
        'event_category': 'engagement',
        'event_label': scenario
      });
      
      // Show loading animation
      showLoading();
      
      // Prepare data for the Cloud Function
      const data = {
        userId: isLoggedIn ? currentUser.getId() : 'anonymous',
        scenario: scenario,
        relationship: relationship,
        tone: tone,
        intensity: intensity,
        duration: duration,
        circumstances: circumstances
      };
      
      console.log('Sending request to Cloud Function:', data);
      
      // Send request to Cloud Function
      fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.GENERATE}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (response.status === 429) {
          throw new Error('Rate limit exceeded. Please try again later.');
        }
        if (!response.ok) {
          throw new Error('Failed to generate message.');
        }
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          // Hide loading animation
          hideLoading();
          
          // Initialize elements if not already done
          if (!resultPopupOverlay || !popupMessageText) {
            initializePopupElements();
          }
          
          // Update popup content with generated message
          if (popupMessageText) {
            popupMessageText.textContent = data.message;
          }
          
          // Update popup insights if available
          if (popupInsightsList) {
            popupInsightsList.innerHTML = '';
            if (data.insights && data.insights.length > 0) {
              data.insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                popupInsightsList.appendChild(li);
              });
            }
          }
          
          // Show the popup overlay with results
          showResultsPopup();
          
          // Additionally, still update the original card for backward compatibility
          const messageText = document.getElementById('message-text');
          if (messageText) {
            messageText.textContent = data.message;
          }
          
          const insightsList = document.getElementById('insights-list');
          if (insightsList) {
            insightsList.innerHTML = '';
            if (data.insights && data.insights.length > 0) {
              data.insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                insightsList.appendChild(li);
              });
            }
          }
          
          // Make sure original card is hidden
          const resultCard = document.getElementById('result');
          if (resultCard) {
            resultCard.style.display = 'none';
          }
          
          // Save message to history if logged in
          if (isLoggedIn) {
            saveMessageToHistory(data.message, scenario, relationship, tone, intensity, duration, circumstances);
          }
        } else {
          hideLoading();
          alert(data.error || 'Failed to generate message.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        hideLoading();
        alert(error.message || 'An error occurred. Please try again.');
      });
    }

    // Add JavaScript for Dashboard navigation
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the app first
      initializeApp();

      // Get dashboard-related buttons
      const dashboardBtn = document.getElementById('dashboard-btn');
      const backToHomeFromDashboard = document.getElementById('back-to-home-from-dashboard');
      const dashboardScreen = document.getElementById('dashboard-screen');
      
      // Add event listeners for dashboard navigation
      if (dashboardBtn) {
        dashboardBtn.addEventListener('click', function() {
          // Hide home screen and show dashboard
          homeScreen.classList.remove('active');
          setTimeout(() => {
            homeScreen.style.display = 'none';
            dashboardScreen.style.display = 'flex';
            setTimeout(() => dashboardScreen.classList.add('active'), 50);
            
            // Load dashboard data when dashboard is shown
            loadDashboardData();
          }, 500);
        });
      }
      
      if (backToHomeFromDashboard) {
        backToHomeFromDashboard.addEventListener('click', function() {
          // Hide dashboard and show home screen
          dashboardScreen.classList.remove('active');
          setTimeout(() => {
            dashboardScreen.style.display = 'none';
            homeScreen.style.display = 'flex';
            setTimeout(() => homeScreen.classList.add('active'), 50);
          }, 500);
        });
      }
    });

    // Add this function to fetch and display user's message statistics and history
    async function loadDashboardData() {
      if (!currentUser) {
        console.error('No user logged in while trying to load dashboard data');
        return;
      }
      
      try {
        // Show loading state
        const statValues = document.querySelectorAll('.stat-value');
        statValues.forEach(el => {
          el.textContent = '...';
        });
        
        const messageHistoryContainer = document.querySelector('.message-history');
        if (messageHistoryContainer) {
          messageHistoryContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading messages...</div>';
        }
        
        // Get user's messages collection
        const messagesRef = firebase.firestore()
          .collection('users')
          .doc(currentUser.uid)
          .collection('messages');
        
        // Get messages ordered by timestamp (newest first)
        const messagesSnapshot = await messagesRef
          .orderBy('timestamp', 'desc')
          .limit(10)
          .get();
        
        // Process message data for statistics and display
        const messages = [];
        const relationshipTypes = new Set();
        const templateTypes = new Set();
        
        messagesSnapshot.forEach(doc => {
          const messageData = doc.data();
          messages.push({
            id: doc.id,
            ...messageData,
            timestamp: messageData.timestamp?.toDate?.() || new Date(),
          });
          
          if (messageData.relationshipType) {
            relationshipTypes.add(messageData.relationshipType);
          }
          
          if (messageData.templateType) {
            templateTypes.add(messageData.templateType);
          }
        });
        
        // Update statistics
        const totalMessages = messages.length;
        const totalRelationships = relationshipTypes.size;
        const totalTemplates = templateTypes.size;
        
        // Find stat elements and update them
        const messageCountEl = document.querySelector('.stat-value[data-stat="messages"]');
        const relationshipsCountEl = document.querySelector('.stat-value[data-stat="relationships"]');
        const templatesCountEl = document.querySelector('.stat-value[data-stat="templates"]');
        
        if (messageCountEl) messageCountEl.textContent = totalMessages;
        if (relationshipsCountEl) relationshipsCountEl.textContent = totalRelationships;
        if (templatesCountEl) templatesCountEl.textContent = totalTemplates;
        
        // Update message history
        if (messageHistoryContainer) {
          if (messages.length > 0) {
            messageHistoryContainer.innerHTML = '';
            
            messages.slice(0, 5).forEach(message => {
              // Format the date
              const messageDate = message.timestamp;
              let dateText = 'Unknown date';
              
              if (messageDate) {
                const now = new Date();
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (messageDate.toDateString() === now.toDateString()) {
                  dateText = 'Today';
                } else if (messageDate.toDateString() === yesterday.toDateString()) {
                  dateText = 'Yesterday';
                } else {
                  // If within last week, show days ago
                  const diffDays = Math.floor((now - messageDate) / (1000 * 60 * 60 * 24));
                  if (diffDays < 7) {
                    dateText = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                  } else {
                    // Otherwise show the date
                    dateText = messageDate.toLocaleDateString(undefined, { 
                      month: 'short', 
                      day: 'numeric' 
                    });
                  }
                }
              }
              
              // Determine the emoji based on relationship or template type
              let emoji = 'ðŸ’¬'; // Default
              
              if (message.relationshipType) {
                if (message.relationshipType.includes('Romantic')) {
                  emoji = 'â¤ï¸';
                } else if (message.relationshipType.includes('Friend')) {
                  emoji = 'âœ‰ï¸';
                } else if (message.relationshipType.includes('Family')) {
                  emoji = 'ðŸ‘‹';
                } else if (message.relationshipType.includes('Professional')) {
                  emoji = 'ðŸ‘”';
                }
              }
              
              if (message.templateType) {
                if (message.templateType === 'apology') {
                  emoji = 'âœ‰ï¸';
                } else if (message.templateType === 'romantic') {
                  emoji = 'â¤ï¸';
                } else if (message.templateType === 'checkin') {
                  emoji = 'ðŸ‘‹';
                } else if (message.templateType === 'tough') {
                  emoji = 'ðŸ’¬';
                } else if (message.templateType === 'gratitude') {
                  emoji = 'ðŸ™';
                } else if (message.templateType === 'celebration') {
                  emoji = 'ðŸŽ‰';
                } else if (message.templateType === 'encouragement') {
                  emoji = 'â­';
                }
              }
              
              // Create message history item
              const item = document.createElement('div');
              item.className = 'message-history-item';
              item.innerHTML = `
                <div class="message-icon">${emoji}</div>
                <div class="message-details">
                  <div class="message-title">${message.scenario || 'No scenario provided'}</div>
                  <div class="message-meta">
                    <span class="message-date">${dateText}</span>
                    <span class="message-relationship">${message.relationshipType || 'Unknown'}</span>
                  </div>
                </div>
              `;
              
              // Add click event to show full message
              item.addEventListener('click', () => {
                // Create a modal to show the full message
                const modal = document.createElement('div');
                modal.className = 'full-message-modal';
                modal.innerHTML = `
                  <div class="full-message-container">
                    <div class="full-message-header">
                      <h3>Message</h3>
                      <button class="close-modal">Ã—</button>
                    </div>
                    <div class="full-message-content">
                      <div class="full-message-scenario">${message.scenario || 'No scenario provided'}</div>
                      <div class="full-message-relationship">${message.relationshipType || 'Unknown'} Â· ${dateText}</div>
                      <div class="full-message-text">${message.message || 'No message content'}</div>
                    </div>
                  </div>
                `;
                
                // Add styles if not already in the document
                if (!document.querySelector('#message-modal-styles')) {
                  const styleEl = document.createElement('style');
                  styleEl.id = 'message-modal-styles';
                  styleEl.textContent = `
                    .full-message-modal {
                      position: fixed;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 100%;
                      background-color: rgba(0, 0, 0, 0.7);
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      z-index: 1000;
                    }
                    .full-message-container {
                      background-color: var(--card-bg);
                      border-radius: 16px;
                      width: 90%;
                      max-width: 500px;
                      max-height: 80vh;
                      overflow-y: auto;
                      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                    }
                    .full-message-header {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 16px 20px;
                      border-bottom: 1px solid var(--border-color);
                    }
                    .full-message-header h3 {
                      margin: 0;
                      font-size: 18px;
                      color: var(--text-primary);
                    }
                    .close-modal {
                      background: none;
                      border: none;
                      color: var(--text-secondary);
                      font-size: 24px;
                      cursor: pointer;
                    }
                    .full-message-content {
                      padding: 20px;
                    }
                    .full-message-scenario {
                      font-size: 16px;
                      font-weight: 600;
                      margin-bottom: 8px;
                      color: var(--text-primary);
                    }
                    .full-message-relationship {
                      font-size: 14px;
                      color: var(--text-secondary);
                      margin-bottom: 16px;
                    }
                    .full-message-text {
                      font-size: 15px;
                      line-height: 1.6;
                      white-space: pre-wrap;
                      color: var(--text-primary);
                    }
                  `;
                  document.head.appendChild(styleEl);
                }
                
                // Add modal to the document
                document.body.appendChild(modal);
                
                // Add close functionality
                const closeBtn = modal.querySelector('.close-modal');
                closeBtn.addEventListener('click', () => {
                  modal.remove();
                });
                
                // Close when clicking outside
                modal.addEventListener('click', (e) => {
                  if (e.target === modal) {
                    modal.remove();
                  }
                });
              });
              
              messageHistoryContainer.appendChild(item);
            });
            
            // If no messages, show a message
            if (messages.length === 0) {
              messageHistoryContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                  No messages yet. Generate your first message to see it here.
                </div>
              `;
            }
          }
        }
        
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        
        // Update with fallback values
        const messageCountEl = document.querySelector('.stat-value[data-stat="messages"]');
        const relationshipsCountEl = document.querySelector('.stat-value[data-stat="relationships"]');
        const templatesCountEl = document.querySelector('.stat-value[data-stat="templates"]');
        
        if (messageCountEl) messageCountEl.textContent = '0';
        if (relationshipsCountEl) relationshipsCountEl.textContent = '0';
        if (templatesCountEl) templatesCountEl.textContent = '0';
        
        const messageHistoryContainer = document.querySelector('.message-history');
        if (messageHistoryContainer) {
          messageHistoryContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
              Could not load message history. Please try again later.
            </div>
          `;
        }
      }
    }

    // Perplexity API Integration
    // Function to retrieve Perplexity API key from Firestore
    async function getPerplexityApiKey() {
      try {
        // Check local storage first
        let perplexityApiKey = localStorage.getItem('perplexity_api_key');
        
        if (perplexityApiKey) {
          console.log('Using Perplexity API key from local storage');
          return perplexityApiKey;
        }
        
        // Get from Firestore if not in local storage
        console.log('Retrieving Perplexity API key from Firestore');
        const doc = await firebase.firestore().collection('secrets').doc('secrets').get();
        
        if (doc.exists && doc.data().perplexitykey) {
          perplexityApiKey = doc.data().perplexitykey;
          localStorage.setItem('perplexity_api_key', perplexityApiKey);
          console.log('Perplexity API key retrieved successfully');
          return perplexityApiKey;
        } else {
          console.error('Perplexity API key document not found in Firestore');
          throw new Error('Perplexity API key not found');
        }
      } catch (error) {
        console.error('Error fetching Perplexity API key:', error);
        throw error;
      }
    }

    // Function to make a Perplexity API call
    async function callPerplexityAPI(prompt) {
      try {
        console.log('Making Perplexity API call with prompt:', prompt);
        const apiKey = await getPerplexityApiKey();
        
        const response = await fetch('https://api.perplexity.ai/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "sonar",
            messages: [
              { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 500,
            top_p: 0.9
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Perplexity API error: ${errorData.error?.message || response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Perplexity API response:', data);
        return data;
      } catch (error) {
        console.error('Perplexity API call failed:', error);
        throw error;
      }
    }

    // Test function for Perplexity API
    async function testPerplexityAPI() {
      try {
        console.log('Testing Perplexity API...');
        const result = await callPerplexityAPI('What are the top 3 benefits of meditation?');
        console.log('Result:', result.choices[0].message.content);
        if (result.citations && result.citations.length > 0) {
          console.log('Citations:', result.citations);
        }
        return result;
      } catch (error) {
        console.error('Test failed:', error);
        return null;
      }
    }

    // You can call testPerplexityAPI() from the browser console to test
    // ... existing code continues ...

      // You can call testPerplexityAPI() from the browser console to test
      
      // Initialize the test button for Perplexity API (development only)
      const initTestButton = () => {
        const testButton = document.getElementById('test-perplexity-btn');
        if (testButton) {
          // Only show in development or if a URL parameter is present
          const isDev = window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1' || 
                         window.location.search.includes('showtest=true');
          
          if (isDev) {
            testButton.style.display = 'block';
            
            // Add click event listener
            testButton.addEventListener('click', async () => {
              testButton.textContent = 'Testing...';
              testButton.disabled = true;
              
              try {
                const result = await testPerplexityAPI();
                
                if (result && result.choices && result.choices[0]) {
                  // Create a floating div to show the result
                  const resultDiv = document.createElement('div');
                  resultDiv.style.position = 'fixed';
                  resultDiv.style.top = '50%';
                  resultDiv.style.left = '50%';
                  resultDiv.style.transform = 'translate(-50%, -50%)';
                  resultDiv.style.background = 'rgba(0, 0, 0, 0.9)';
                  resultDiv.style.color = 'white';
                  resultDiv.style.padding = '20px';
                  resultDiv.style.borderRadius = '12px';
                  resultDiv.style.zIndex = '1000';
                  resultDiv.style.maxWidth = '80%';
                  resultDiv.style.maxHeight = '80%';
                  resultDiv.style.overflow = 'auto';
                  
                  // Add close button
                  const closeBtn = document.createElement('button');
                  closeBtn.textContent = 'Close';
                  closeBtn.style.background = '#555';
                  closeBtn.style.color = 'white';
                  closeBtn.style.border = 'none';
                  closeBtn.style.padding = '8px 16px';
                  closeBtn.style.borderRadius = '4px';
                  closeBtn.style.marginTop = '15px';
                  closeBtn.style.cursor = 'pointer';
                  closeBtn.onclick = () => document.body.removeChild(resultDiv);
                  
                  // Add content
                  resultDiv.innerHTML = `
                    <h3>Perplexity API Test Result</h3>
                    <p><strong>Response:</strong> ${result.choices[0].message.content}</p>
                    ${result.citations && result.citations.length > 0 ? `
                      <p><strong>Citations:</strong></p>
                      <ul>
                        ${result.citations.map(citation => `<li><a href="${citation}" target="_blank">${citation}</a></li>`).join('')}
                      </ul>
                    ` : ''}
                  `;
                  resultDiv.appendChild(closeBtn);
                  document.body.appendChild(resultDiv);
                }
                
                showAlert('Perplexity API test successful! Check console for details.', 'success');
              } catch (error) {
                showAlert(`Perplexity API test failed: ${error.message}`, 'error');
              } finally {
                testButton.textContent = 'Test Perplexity API';
                testButton.disabled = false;
              }
            });
          }
        }
      };
      
      // Call the init function after the DOM is loaded
      document.addEventListener('DOMContentLoaded', () => {
        initTestButton();
        
        // Initialize the Learn button
        const learnButton = document.getElementById('learn-btn');
        if (learnButton) {
          learnButton.addEventListener('click', async () => {
            try {
              // Change button appearance
              learnButton.disabled = true;
              learnButton.innerHTML = '<span class="new-conversation-icon">â³</span> Testing...';
              
              // Test prompt
              const testPrompt = "What are three benefits of emotional intelligence in relationships?";
              
              // Call Perplexity API
              const result = await callPerplexityAPI(testPrompt);
              
              // Show simple alert with success or failure
              if (result && result.choices && result.choices[0]) {
                alert("âœ… Perplexity API Test Successful!");
              } else {
                alert("âŒ API returned empty or invalid response");
              }
            } catch (error) {
              // Show error
              alert("âŒ Perplexity API Test Failed: " + error.message);
              console.error("Perplexity test error:", error);
            } finally {
              // Reset button
              learnButton.disabled = false;
              learnButton.innerHTML = '<span class="new-conversation-icon">ðŸ§ </span> Learn';
            }
          });
        }
      });
  </script>
</body>
</html> 